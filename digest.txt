Directory structure:
└── src/
    ├── app/
    │   ├── globals.css
    │   ├── layout.tsx
    │   ├── page.tsx
    │   ├── api/
    │   │   ├── analytics/
    │   │   │   └── merchant/
    │   │   │       └── [merchantId]/
    │   │   │           └── route.ts
    │   │   ├── auth/
    │   │   │   └── signup/
    │   │   │       └── route.ts
    │   │   ├── buy-orders/
    │   │   │   ├── route.ts
    │   │   │   └── create/
    │   │   │       └── route.ts
    │   │   ├── merchants/
    │   │   │   └── [id]/
    │   │   │       └── stats/
    │   │   │           └── route.ts
    │   │   ├── products/
    │   │   │   ├── route.ts
    │   │   │   └── update-price/
    │   │   │       └── route.ts
    │   │   ├── stripe/
    │   │   │   └── connect/
    │   │   │       └── route.ts
    │   │   ├── test/
    │   │   │   └── route.ts
    │   │   └── webhooks/
    │   │       └── stripe/
    │   │           └── route.ts
    │   ├── customer/
    │   │   └── page.tsx
    │   └── dashboard/
    │       └── page.tsx
    ├── components/
    │   ├── Logo.tsx
    │   └── index.ts
    ├── lib/
    │   ├── auth.ts
    │   ├── database.ts
    │   ├── payments.ts
    │   ├── supabase.ts
    │   └── integrations/
    │       └── index.ts
    └── types/
        └── database.ts

================================================
File: app/globals.css
================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: #ffffff;
  --foreground: #171717;
  --primary: #10344C;
  --primary-medium: #1e5b8a;
  --primary-light: #2d81c4;
  --accent: #FACC15;
  --accent-light: #FDE68A;
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to bottom right, rgb(248 250 252), rgb(241 245 249));
  color: var(--primary);
  -webkit-font-smoothing: antialiased;
}

.btn-primary {
  background: linear-gradient(to right, var(--primary), var(--primary-medium));
  color: white;
  font-weight: 600;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.btn-primary:hover {
  box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  transform: translateY(-2px);
}

.btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: all 0.5s;
}

.btn-primary:hover::before {
  left: 100%;
}

.feature-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(16, 52, 76, 0.1);
  border-radius: 1rem;
  transition: all 0.4s;
}

.feature-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
  border-color: rgba(16, 52, 76, 0.2);
}

.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 600;
}

.status-monitoring {
  background-color: rgb(220 252 231);
  color: rgb(22 101 52);
}

.status-pending {
  background-color: rgb(255 237 213);
  color: rgb(194 65 12);
}

.status-accepted {
  background-color: rgb(204 251 241);
  color: rgb(17 94 89);
}

.progress-bar {
  height: 0.5rem;
  border-radius: 9999px;
  background-color: rgba(16, 52, 76, 0.1);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(to right, var(--primary), var(--primary-medium));
  border-radius: 9999px;
  transition: all 1s;
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-15px); }
}

.floating {
  animation: float 6s ease-in-out infinite;
}

.scroll-animate {
  opacity: 0;
  transform: translateY(2rem);
  transition: all 0.8s;
}

.scroll-animate.animate-in {
  opacity: 1;
  transform: translateY(0);
}


/* Custom styles from index.html */
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    color: #10344C;
}

.hero-gradient {
    background: linear-gradient(135deg, #10344C 0%, #1e5b8a 100%);
}

.limina-logo {
    width: 60px;
    height: 60px;
}

.limina-logo svg {
    width: 100%;
    height: 100%;
    display: block;
    overflow: visible;
}

/* Enhanced Logo animations */
#header-check {
    stroke-dasharray: 200;
    stroke-dashoffset: 200;
    animation: draw-check 0.8s ease-out forwards;
}

@keyframes draw-check {
    to { stroke-dashoffset: 0; }
}

#header-coin {
    transform-origin: 39px 50px;
    opacity: 0;
    animation: coin-emerge-spin 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.25s forwards;
    filter: drop-shadow(0px 2px 6px rgba(250, 204, 21, 0.6));
}

@keyframes coin-emerge-spin {
    0% {
        transform: scale(0.3) translateY(20px) rotateY(0deg);
        opacity: 0;
    }
    60% {
        transform: scale(1.15) translateY(-10px) rotateY(180deg);
        opacity: 1;
    }
    100% {
        transform: scale(1) translateY(0px) rotateY(360deg);
        opacity: 1;
    }
}

/* Enhanced text animation for logo */
.logo-text {
    background: linear-gradient(90deg, #10344C 30%, #1e5b8a 70%);
    background-size: 0% 100%;
    background-repeat: no-repeat;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0;
    animation: text-reveal-fade-in 0.8s ease-out 0.15s forwards;
}

@keyframes text-reveal-fade-in {
    0% {
        background-size: 0% 100%;
        opacity: 0;
        transform: translateY(5px);
    }
    100% {
        background-size: 100% 100%;
        opacity: 1;
        transform: translateY(0px);
    }
}

/* Navigation improvements */
.nav-link {
    position: relative;
    transition: all 0.3s ease;
}

.nav-link::after {
    content: '';
    position: absolute;
    width: 0;
    height: 2px;
    bottom: -2px;
    left: 0;
    background: #FACC15;
    transition: width 0.3s ease;
}

.nav-link:hover::after,
.nav-link.active::after {
    width: 100%;
}

/* Card hover effects */
.feature-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(16, 52, 76, 0.1);
    border-radius: 1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.feature-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    border-color: rgba(16, 52, 76, 0.2);
}

/* Enhanced button styles */
.btn-primary {
    background: linear-gradient(135deg, #10344C 0%, #1e5b8a 100%);
    border: none;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 40px rgba(16, 52, 76, 0.3);
}

.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-primary:hover::before {
    left: 100%;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 2px solid #10344C;
    color: #10344C;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #10344C;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 15px 30px rgba(16, 52, 76, 0.2);
}

/* Floating animations */
.floating {
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-15px); }
}

/* Scroll animations */
.scroll-animate {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease, transform 0.8s ease;
}

.scroll-animate.animate-in {
    opacity: 1;
    transform: translateY(0);
}

/* Stagger animation delays */
.stagger-item:nth-child(1) { transition-delay: 0.1s; }
.stagger-item:nth-child(2) { transition-delay: 0.2s; }
.stagger-item:nth-child(3) { transition-delay: 0.3s; }
.stagger-item:nth-child(4) { transition-delay: 0.4s; }

/* Mobile menu improvements */
.mobile-menu {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.hamburger-line {
    transition: all 0.3s ease;
}

.hamburger-open .line1 {
    transform: translateY(7px) rotate(45deg);
}

.hamburger-open .line2 {
    opacity: 0;
}

.hamburger-open .line3 {
    transform: translateY(-7px) rotate(-45deg);
}

/* Hero card glass effect */
.hero-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

/* Progress indicators */
.progress-bar {
    height: 6px;
    border-radius: 3px;
    background: rgba(16, 52, 76, 0.1);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #1e5b8a, #10344C);
    border-radius: 3px;
    transition: width 1s ease-in-out;
}

/* Status badges */
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-coming-soon {
    background: #dbeafe;
    color: #1e40af;
}

.status-prototype {
    background: #fef3c7;
    color: #854d0e;
}

.status-monitoring {
    background: #dcfce7;
    color: #166534;
}

.status-pending {
    background: #fed7d7;
    color: #9b2c2c;
}
 .status-accepted {
    background: #ccfbf1; /* Teal-100 */
    color: #0f766e;    /* Teal-700 */
}

/* Dashboard tabs */
.dashboard-tab {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.dashboard-tab.active {
    background: linear-gradient(135deg, #10344C 0%, #1e5b8a 100%);
    color: white;
    border-color: #10344C;
}

.dashboard-tab:not(.active) {
    background: rgba(255, 255, 255, 0.7);
    color: #10344C;
    border-color: rgba(16, 52, 76, 0.2);
}

.dashboard-tab:not(.active):hover {
    background: rgba(16, 52, 76, 0.1);
    border-color: rgba(16, 52, 76, 0.3);
}

/* Demand analytics */
.demand-bar {
    height: 8px;
    border-radius: 4px;
    background: rgba(16, 52, 76, 0.1);
    overflow: hidden;
}

.demand-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 1s ease-in-out;
}

/* Bid indicators */
.bid-indicator {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: 700;
}

.bid-high {
    background: #fee2e2;
    color: #dc2626;
}

.bid-medium {
    background: #fef3c7;
    color: #d97706;
}

.bid-low {
    background: #dcfce7;
    color: #16a34a;
}

/* Pulse effect for real-time updates */
.pulse-dot {
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Smooth scrolling behavior */
html {
    scroll-behavior: smooth;
}

/* Section spacing */
.section-padding {
    padding: 5rem 0;
}

@media (max-width: 768px) {
    .section-padding {
        padding: 3rem 0;
    }
}

/* Pulsing effect for coming soon elements */
.pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite alternate;
}

@keyframes pulse-glow {
    from {
        box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
    }
    to {
        box-shadow: 0 0 30px rgba(250, 204, 21, 0.6);
    }
}

/* Exciting glimmering button effect */
.btn-glimmer {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #FACC15 0%, #F59E0B 50%, #FACC15 100%);
    background-size: 200% 100%;
    animation: shimmer 3s ease-in-out infinite, glow-pulse 2s ease-in-out infinite alternate;
    transform: translateY(0);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-glimmer::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
    transition: left 0.6s;
}

.btn-glimmer:hover {
    transform: translateY(-3px) scale(1.02);
    animation: shimmer 1.5s ease-in-out infinite, glow-pulse-intense 1s ease-in-out infinite alternate;
}

.btn-glimmer:hover::before {
    left: 100%;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

@keyframes glow-pulse {
    from {
        box-shadow: 0 0 20px rgba(250, 204, 21, 0.5), 0 0 40px rgba(250, 204, 21, 0.2);
    }
    to {
        box-shadow: 0 0 30px rgba(250, 204, 21, 0.8), 0 0 60px rgba(250, 204, 21, 0.4);
    }
}

@keyframes glow-pulse-intense {
    from {
        box-shadow: 0 0 25px rgba(250, 204, 21, 0.7), 0 0 50px rgba(250, 204, 21, 0.3);
    }
    to {
        box-shadow: 0 0 40px rgba(250, 204, 21, 1), 0 0 80px rgba(250, 204, 21, 0.6);
    }
}

/* Fixed Hero Layout for better positioning */
.hero-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: center;
    min-height: 600px;
}

@media (max-width: 1024px) {
    .hero-layout {
        grid-template-columns: 1fr;
        gap: 2rem;
        text-align: center;
    }
}

/* Enhanced hero card positioning */
.hero-card-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

@media (min-width: 1024px) {
    .hero-card-container {
        justify-content: flex-start;
    }
}

/* B2B specific styles */
.b2b-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0284c7;
}

.moq-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: #fef3c7;
    border-radius: 0.5rem;
    font-weight: 600;
    color: #92400e;
}


================================================
File: app/layout.tsx
================================================
import React from 'react'
import type { Metadata } from 'next'
import { Poppins } from 'next/font/google'
import './globals.css'

const poppins = Poppins({
  subsets: ['latin'],
  weight: ['400', '500', '600', '700'],
  variable: '--font-poppins',
})

export const metadata: Metadata = {
  title: 'Limina - Conditional Buy Order Checkout',
  description: 'Manage your conditional buy orders and track your revenue',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" className="scroll-smooth">
      <body className={`${poppins.variable} font-poppins antialiased`}>
        {children}
      </body>
    </html>
  )
} 


================================================
File: app/page.tsx
================================================
'use client'

import React, { useState, useEffect } from 'react'
import Image from 'next/image'
import { Logo } from '@/components/Logo'
import { ShoppingCart, Store, Building, Target, ArrowRight, CheckCircle, Rocket, Info, ArrowDown, Heart, BarChart3, Users, Eye, Activity } from 'lucide-react'

export default function LandingPage() {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false)
  const [activeTab, setActiveTab] = useState('retail')
  const [heroPrice, setHeroPrice] = useState(849)
  
  // Animation effects
  useEffect(() => {
    // Scroll animation observer
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    }

    const scrollObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in')
          scrollObserver.unobserve(entry.target)
        }
      })
    }, observerOptions)

    document.querySelectorAll('.scroll-animate').forEach(el => {
      scrollObserver.observe(el)
    })

    return () => scrollObserver.disconnect()
  }, [])

  const handleHeroOrderSubmit = () => {
    // Demo functionality
    alert(`Demo: Buy Order created for £${heroPrice}! \n\nThis would normally:\n• Monitor price changes\n• Notify when conditions are met\n• Complete purchase automatically`)
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white">
      {/* Navigation */}
      <nav className="fixed w-full bg-white/90 backdrop-blur-md z-50 shadow-sm transition-all duration-300">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-20 items-center">
            <div className="flex items-center">
              <div className="flex items-center group cursor-pointer">
                <Logo />
                <span className="text-2xl font-bold ml-3 logo-text group-hover:text-primary transition-colors">LIMINA</span>
              </div>
            </div>
            
            <div className="hidden md:flex items-center space-x-8">
              <a href="#what-we-do" className="nav-link text-gray-700 font-medium hover:text-primary">What We Do</a>
              <a href="#how-it-works" className="nav-link text-gray-700 font-medium hover:text-primary">How It Works</a>
              <a href="#solutions" className="nav-link text-gray-700 font-medium hover:text-primary">Solutions</a>
              <a href="#demo" className="nav-link text-gray-700 font-medium hover:text-primary">Demo</a>
            </div>
            
            <div className="flex items-center space-x-4">
              <a href="/dashboard" className="hidden lg:inline-flex items-center px-4 py-2 border border-primary/20 rounded-full text-sm font-medium text-primary hover:bg-primary/10 transition-colors">
                🏪 Merchant Demo
              </a>
              <a href="/customer" className="hidden lg:inline-flex items-center px-4 py-2 border border-primary/20 rounded-full text-sm font-medium text-primary hover:bg-primary/10 transition-colors">
                🛍️ Customer Demo
              </a>
              <button className="hidden md:inline-flex items-center px-6 py-3 btn-primary rounded-full text-base font-medium shadow-lg pulse-glow">
                Get Started
                <ArrowRight className="ml-2 w-4 h-4" />
              </button>
              
              <button 
                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                className="md:hidden ml-4 p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary transition-colors"
              >
                <span className="sr-only">Open main menu</span>
                <div className={`hamburger-icon space-y-1.5 ${mobileMenuOpen ? 'hamburger-open' : ''}`}>
                  <span className="hamburger-line line1 block w-6 h-0.5 bg-gray-700"></span>
                  <span className="hamburger-line line2 block w-6 h-0.5 bg-gray-700"></span>
                  <span className="hamburger-line line3 block w-6 h-0.5 bg-gray-700"></span>
                </div>
              </button>
            </div>
          </div>
        </div>
        
        {/* Mobile Menu */}
        {mobileMenuOpen && (
          <div className="md:hidden mobile-menu">
            <div className="px-4 py-6 space-y-4">
              <a href="#what-we-do" className="nav-link block text-gray-700 font-medium hover:text-primary transition-colors">What We Do</a>
              <a href="#how-it-works" className="nav-link block text-gray-700 font-medium hover:text-primary transition-colors">How It Works</a>
              <a href="#solutions" className="nav-link block text-gray-700 font-medium hover:text-primary transition-colors">Solutions</a>
              <a href="#demo" className="nav-link block text-gray-700 font-medium hover:text-primary transition-colors">Demo</a>
              <div className="border-t border-gray-200 pt-4 mt-4">
                <a href="/dashboard" className="nav-link block text-primary font-medium hover:text-primary-medium transition-colors">🏪 Merchant Demo</a>
                <a href="/customer" className="nav-link block text-primary font-medium hover:text-primary-medium transition-colors mt-2">🛍️ Customer Demo</a>
              </div>
              <button className="block w-full text-center px-6 py-3 btn-primary rounded-full font-medium mt-4">
                Get Started
              </button>
            </div>
          </div>
        )}
      </nav>

      {/* Hero Section */}
      <section className="hero-gradient pt-32 pb-20 section-padding">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="hero-layout">
            <div className="scroll-animate">
              <div className="inline-flex items-center px-4 py-2 bg-white/20 backdrop-blur-md rounded-full mb-8">
                <span className="text-accent font-medium">🚀 In Development</span>
                <span className="ml-2 px-2 py-1 bg-accent text-primary text-xs rounded-full font-bold">EARLY ACCESS</span>
              </div>
              
              <h1 className="text-4xl lg:text-6xl font-extrabold leading-tight mb-6 text-white">
                Conditional Buy Orders
                <span className="block text-accent">That Convert Intent into Sales</span>
              </h1>
              
              <p className="text-xl text-gray-200 mb-8 max-w-2xl">
                Enable customers and businesses to commit to purchase when their conditions are met. 
                <span className="font-semibold text-white">Capture demand you&apos;re currently losing to price sensitivity, timing, and complex B2B procurement.</span>
              </p>
              
              <div className="flex flex-col sm:flex-row gap-4 mb-12">
                <button 
                  onClick={() => document.getElementById('what-we-do')?.scrollIntoView({ behavior: 'smooth' })}
                  className="btn-glimmer px-8 py-4 rounded-full text-lg font-medium inline-flex items-center justify-center text-primary shadow-lg font-semibold"
                >
                  Discover LIMINA
                  <ArrowDown className="ml-2 w-5 h-5" />
                </button>
                <button className="btn-secondary px-8 py-4 rounded-full text-lg font-medium inline-flex items-center justify-center">
                  Get Early Access
                  <Rocket className="ml-2 w-5 h-5" />
                </button>
              </div>
              
              <div className="grid grid-cols-3 gap-8 pt-8 border-t border-white/20">
                <div className="text-center stagger-item scroll-animate">
                  <div className="text-3xl font-bold text-accent mb-1">70%</div>
                  <div className="text-sm text-gray-300">Cart Abandonment Rate</div>
                </div>
                <div className="text-center stagger-item scroll-animate">
                  <div className="text-3xl font-bold text-accent mb-1">48%</div>
                  <div className="text-sm text-gray-300">Abandon Due to Price</div>
                </div>
                <div className="text-center stagger-item scroll-animate">
                  <div className="text-3xl font-bold text-accent mb-1">£260B</div>
                  <div className="text-sm text-gray-300">Recoverable Revenue</div>
                </div>
              </div>
            </div>
            
            {/* Hero Card */}
            <div className="hero-card-container">
              <div className="hero-card floating rounded-3xl p-8 w-full max-w-md scroll-animate">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center">
                    <Image 
                      className="h-16 w-16 rounded-2xl object-cover" 
                      src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiMxOTE5MTkiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjciIHg9IjMiIHk9IjMiIHJ4PSIxIi8+CjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjciIHg9IjE0IiB5PSIzIiByeD0iMSIvPgo8cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSI3IiB4PSIxNCIgeT0iMTQiIHJ4PSIxIi8+CjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjciIHg9IjMiIHk9IjE0IiByeD0iMSIvPgo8L3N2Zz4KPC9zdmc+"
                      alt="iPhone 16 Pro"
                      width={64}
                      height={64}
                    />
                    <div className="ml-4">
                      <h3 className="font-semibold text-gray-800 text-lg">iPhone 16 Pro</h3>
                      <p className="text-gray-600">Current: <span className="text-xl font-bold">£999</span></p>
                    </div>
                  </div>
                  <span className="status-badge status-prototype">Demo</span>
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-800 font-medium mb-2">I&apos;ll buy at this price</label>
                    <div className="relative">
                      <span className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">£</span>
                      <input 
                        type="number" 
                        value={heroPrice}
                        onChange={(e) => setHeroPrice(Number(e.target.value))}
                        className="w-full px-4 py-3 pl-10 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all" 
                        placeholder="Enter price"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-gray-800 font-medium mb-2">Valid for</label>
                    <select className="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all">
                      <option>7 days</option>
                      <option>30 days</option>
                      <option>60 days</option>
                      <option>90 days</option>
                    </select>
                  </div>
                  
                  <button 
                    onClick={handleHeroOrderSubmit}
                    className="btn-primary w-full text-lg py-4 rounded-lg font-semibold flex items-center justify-center"
                  >
                    <Heart className="mr-2 w-5 h-5" />
                    Create Buy Order
                  </button>
                  
                  <p className="text-center text-gray-500 text-sm flex items-center justify-center">
                    <Info className="mr-1 w-4 h-4 text-blue-500" />
                    Concept demonstration. Not processing real orders.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      {/* What We Do Section */}
      <section id="what-we-do" className="section-padding bg-white">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h2 className="text-3xl lg:text-4xl font-bold text-gray-900 mb-6 scroll-animate">What is LIMINA?</h2>
            <p className="text-xl text-gray-600 max-w-3xl mx-auto scroll-animate">
              LIMINA is a conditional buy order checkout service that merchants and businesses integrate into their platforms. 
              We enable customers and B2B buyers to commit to purchase when specific conditions are met - turning abandoned carts 
              and unmet procurement needs into future guaranteed sales.
            </p>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div className="feature-card p-8 text-center stagger-item scroll-animate">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-primary to-primary-medium flex items-center justify-center text-white">
                <ShoppingCart className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-bold mb-4 text-gray-800">For Shoppers</h3>
              <p className="text-gray-600 leading-relaxed">
                Commit to buy at your ideal price. We automatically complete the purchase when conditions are met - 
                no more missing deals or checking prices daily.
              </p>
            </div>
            
            <div className="feature-card p-8 text-center stagger-item scroll-animate">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-accent to-orange-400 flex items-center justify-center text-primary">
                <Store className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-bold mb-4 text-gray-800">For Merchants</h3>
              <p className="text-gray-600 leading-relaxed">
                Convert price-sensitive browsers into committed buyers. See real demand at different price points and 
                capture sales you&apos;d otherwise lose.
              </p>
            </div>
            
            <div className="feature-card p-8 text-center stagger-item scroll-animate">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white">
                <Building className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-bold mb-4 text-gray-800">For B2B</h3>
              <p className="text-gray-600 leading-relaxed">
                Facilitate conditional B2B transactions. Buyers can submit binding purchase orders with specific price, 
                quantity, and timeline conditions. Supports MOQ aggregation and group buys.
              </p>
            </div>
          </div>
        </div>
      </section>

      {/* Demo Section */}
      <section id="demo" className="section-padding bg-gradient-to-br from-primary/5 to-primary-medium/10">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h2 className="text-3xl lg:text-4xl font-bold text-gray-900 mb-6 scroll-animate">Live Demo: See LIMINA in Action</h2>
            <p className="text-xl text-gray-600 max-w-2xl mx-auto scroll-animate">Experience how conditional buy orders work for different use cases</p>
          </div>

          <div className="flex justify-center mb-8">
            <div className="inline-flex bg-white/50 backdrop-blur-md rounded-2xl p-2 shadow-lg">
              <button 
                onClick={() => setActiveTab('retail')}
                className={`dashboard-tab flex items-center space-x-2 ${activeTab === 'retail' ? 'active' : ''}`}
              >
                <ShoppingCart className="w-4 h-4" />
                <span>Retail Demo</span>
              </button>
              <button 
                onClick={() => setActiveTab('b2b')}
                className={`dashboard-tab flex items-center space-x-2 ${activeTab === 'b2b' ? 'active' : ''}`}
              >
                <Building className="w-4 h-4" />
                <span>B2B Demo</span>
              </button>
              <button 
                onClick={() => setActiveTab('merchant')}
                className={`dashboard-tab flex items-center space-x-2 ${activeTab === 'merchant' ? 'active' : ''}`}
              >
                <BarChart3 className="w-4 h-4" />
                <span>Merchant View</span>
              </button>
            </div>
          </div>

          {/* Demo Content */}
          <div className="max-w-4xl mx-auto">
            {activeTab === 'retail' && (
              <div className="feature-card overflow-hidden floating scroll-animate">
                <div className="p-6 bg-gradient-to-r from-primary to-primary-medium text-white">
                  <h3 className="text-xl font-bold flex items-center">
                    <Users className="mr-3 w-6 h-6" />
                    Shopper Dashboard - Active Buy Orders
                  </h3>
                  <p className="mt-2 text-primary-light">Your conditional purchases at a glance</p>
                </div>
                
                <div className="p-6">
                  <div className="flex items-center justify-between mb-6">
                    <h4 className="font-semibold text-gray-800">Active Orders</h4>
                    <div className="flex items-center space-x-2">
                      <span className="status-badge status-monitoring">3 Active</span>
                      <div className="pulse-dot w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                  </div>
                  
                  <div className="space-y-4">
                    <div className="border border-blue-200 rounded-lg p-4 bg-blue-50">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-semibold text-gray-800">MacBook Pro 14&quot;</h4>
                          <p className="text-sm text-gray-600">Buy at: £1,699 | Current: £1,799</p>
                        </div>
                        <span className="status-badge status-monitoring">Monitoring</span>
                      </div>
                      <div className="flex justify-between items-center text-sm">
                        <span className="text-blue-600 font-medium flex items-center">
                          <Activity className="mr-1 w-4 h-4" />
                          94% chance based on price history
                        </span>
                        <span className="text-gray-500">23 days left</span>
                      </div>
                      <div className="mt-2">
                        <div className="progress-bar">
                          <div className="progress-fill bg-blue-500" style={{width: '94%'}}></div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="border border-green-200 rounded-lg p-4 bg-green-50">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-semibold text-gray-800">Sony WH-1000XM5</h4>
                          <p className="text-sm text-gray-600">Buy at: £279 | Purchased: £279</p>
                        </div>
                        <span className="status-badge status-monitoring">✓ Complete</span>
                      </div>
                      <div className="flex justify-between items-center text-sm">
                        <span className="text-green-600 font-medium flex items-center">
                          <CheckCircle className="mr-1 w-4 h-4" />
                          Saved £50 (15%) from original price
                        </span>
                        <span className="text-gray-500">2 days ago</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'merchant' && (
              <div className="feature-card overflow-hidden floating scroll-animate">
                <div className="p-6 bg-gradient-to-r from-accent to-orange-400 text-primary">
                  <h3 className="text-xl font-bold flex items-center">
                    <Eye className="mr-3 w-6 h-6" />
                    Merchant Analytics Dashboard
                  </h3>
                  <p className="mt-2 text-primary/80">Real-time demand intelligence</p>
                </div>
                
                <div className="p-6">
                  <div className="flex items-center justify-between mb-6">
                    <h4 className="font-semibold text-gray-800">Buy Order Analytics</h4>
                    <div className="flex items-center space-x-2">
                      <span className="status-badge status-monitoring flex items-center">
                        <Eye className="mr-1 w-4 h-4" />
                        247 Active Orders
                      </span>
                    </div>
                  </div>
                  
                  <div className="space-y-4">
                    <div className="border border-red-200 rounded-lg p-4 bg-red-50">
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <h4 className="font-semibold text-gray-800">iPhone 16 Pro</h4>
                          <p className="text-sm text-gray-600">Current: £999 | Your cost: £720</p>
                        </div>
                        <div className="bid-indicator bid-high">
                          87
                        </div>
                      </div>
                      <div className="text-sm text-gray-700 mb-2">
                        <span className="font-medium">87 customers</span> will buy at <span className="font-bold text-red-600">£899</span>
                      </div>
                      <div className="demand-bar mb-2">
                        <div className="demand-fill bg-red-500" style={{width: '89%'}}></div>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-red-600 font-medium text-sm">Revenue opportunity: £78,213</span>
                        <button className="px-3 py-1 bg-red-600 text-white rounded text-sm font-semibold hover:bg-red-700">
                          Execute Orders
                        </button>
                      </div>
                    </div>

                    <div className="grid grid-cols-3 gap-4 pt-4 border-t">
                      <div className="text-center">
                        <p className="text-gray-600 text-sm">Total Potential</p>
                        <p className="text-2xl font-bold text-primary">£142K</p>
                      </div>
                      <div className="text-center">
                        <p className="text-gray-600 text-sm">Avg Discount</p>
                        <p className="text-2xl font-bold text-accent">12%</p>
                      </div>
                      <div className="text-center">
                        <p className="text-gray-600 text-sm">Conversion Rate</p>
                        <p className="text-2xl font-bold text-green-600">89%</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'b2b' && (
              <div className="feature-card b2b-card overflow-hidden floating scroll-animate">
                <div className="p-6 bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                  <h3 className="text-xl font-bold flex items-center">
                    <Target className="mr-3 w-6 h-6" />
                    B2B Conditional PO Management
                  </h3>
                  <p className="mt-2 text-blue-100">Buyer & Supplier View (Demo)</p>
                </div>
                
                <div className="p-6">
                  <div className="space-y-6">
                    <div className="border-2 border-blue-300 rounded-lg p-6 bg-blue-50">
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <h4 className="font-bold text-lg text-gray-800">Steel Components (Grade S275)</h4>
                          <p className="text-gray-600">Buyer: Acme Construction Ltd.</p>
                        </div>
                        <span className="status-badge status-pending">Pending Supplier Review</span>
                      </div>
                      
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <div>
                          <p className="text-sm text-gray-600">Committed Quantity</p>
                          <p className="text-2xl font-bold text-gray-800">500 units</p>
                        </div>
                        <div>
                          <p className="text-sm text-gray-600">Target Price/unit</p>
                          <p className="text-2xl font-bold text-blue-600">£45.00</p>
                        </div>
                        <div>
                          <p className="text-sm text-gray-600">PO Validity</p>
                          <p className="text-xl font-bold text-gray-800">45 days</p>
                        </div>
                      </div>
                      
                      <div className="mb-4">
                        <div className="flex justify-between text-sm mb-1">
                          <span>Supplier Action Required</span>
                          <span className="font-semibold text-orange-500">Awaiting Acceptance</span>
                        </div>
                        <div className="demand-bar">
                          <div className="demand-fill bg-orange-400" style={{width: '30%'}}></div>
                        </div>
                      </div>
                      
                      <div className="flex items-center justify-between">
                        <p className="text-sm text-gray-600 flex items-center">
                          <Building className="mr-1 w-4 h-4" />
                          Supplier: Global Steel Inc. (Demo)
                        </p>
                        <button className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center">
                          <CheckCircle className="mr-1 w-4 h-4" />
                          Accept Conditional PO
                        </button>
                      </div>
                    </div>
                    
                    <div className="border border-green-200 rounded-lg p-6 bg-green-50">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-semibold text-gray-800">Bulk Order: Fasteners M12</h4>
                          <p className="text-sm text-gray-600">Buyer: ConstructCo | Supplier: BoltWorld</p>
                          <p className="text-sm text-gray-600">Status: Accepted, Awaiting Price Match for Execution</p>
                        </div>
                        <span className="status-badge status-accepted">PO Accepted</span>
                      </div>
                      <p className="text-green-600 font-medium flex items-center">
                        <Heart className="mr-1 w-4 h-4" />
                        Order will execute if price drops to £0.85/unit by July 15th.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-primary text-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div className="lg:col-span-2">
              <div className="flex items-center mb-6">
                <Logo />
                <span className="text-2xl font-bold ml-3">LIMINA</span>
              </div>
              <p className="text-primary-light text-lg mb-6 max-w-md">
                Pioneering conditional commerce through intelligent buy order technology. Converting abandoned intent 
                and complex B2B needs into guaranteed sales.
              </p>
            </div>
            
            <div>
              <h3 className="text-lg font-semibold mb-4">Platform</h3>
              <ul className="space-y-3">
                <li><a href="#what-we-do" className="text-primary-light hover:text-white transition-colors">What We Do</a></li>
                <li><a href="#how-it-works" className="text-primary-light hover:text-white transition-colors">How It Works</a></li>
                <li><a href="#solutions" className="text-primary-light hover:text-white transition-colors">Solutions</a></li>
                <li><a href="#demo" className="text-primary-light hover:text-white transition-colors">Demo</a></li>
              </ul>
            </div>
            
            <div>
              <h3 className="text-lg font-semibold mb-4">Company</h3>
              <ul className="space-y-3">
                <li><a href="#" className="text-primary-light hover:text-white transition-colors">Documentation (Coming Soon)</a></li>
                <li><a href="#" className="text-primary-light hover:text-white transition-colors">Integration Guide (Coming Soon)</a></li>
                <li><a href="#" className="text-primary-light hover:text-white transition-colors">Contact / Early Access</a></li>
              </ul>
            </div>
          </div>
          
          <div className="border-t border-white/20 mt-12 pt-8 flex flex-col md:flex-row justify-between items-center">
            <p className="text-primary-light">© 2025 LIMINA Technologies Ltd. All rights reserved.</p>
            <div className="mt-4 md:mt-0 flex space-x-6">
              <a href="#" className="text-primary-light hover:text-white transition-colors">Privacy Policy</a>
              <a href="#" className="text-primary-light hover:text-white transition-colors">Terms of Service</a>
            </div>
          </div>
        </div>
      </footer>
    </div>
  )
}



================================================
File: app/api/analytics/merchant/[merchantId]/route.ts
================================================
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'

export async function GET(
  req: NextRequest,
  { params }: { params: { merchantId: string } }
) {
  try {
    const supabase = createRouteHandlerClient({ cookies })
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError || !user) throw new Error('Authentication required')

    // Verify merchant ownership
    const { data: merchant, error: merchantError } = await supabase
      .from('merchants')
      .select('id')
      .eq('id', params.merchantId)
      .eq('user_id', user.id)
      .single()
    if (merchantError || !merchant) throw new Error('Unauthorized')

    // Get comprehensive analytics
    const [
      { data: orders },
      { data: products },
      { data: payments },
      { data: recentActivity }
    ] = await Promise.all([
      // Buy orders analytics
      supabase
        .from('buy_orders')
        .select(`
          *,
          products!inner(title, current_price, price)
        `)
        .eq('merchant_id', params.merchantId),
      // Products with demand data
      supabase
        .from('products')
        .select(`
          *,
          buy_orders(count)
        `)
        .eq('merchant_id', params.merchantId),
      // Payment analytics
      supabase
        .from('escrow_payments')
        .select(`
          *,
          buy_orders!inner(merchant_id)
        `)
        .eq('buy_orders.merchant_id', params.merchantId),
      // Recent activity
      supabase
        .from('buy_orders')
        .select(`
          id,
          status,
          target_price,
          created_at,
          fulfilled_at,
          products!inner(title),
          customers!inner(name, email)
        `)
        .eq('merchant_id', params.merchantId)
        .order('created_at', { ascending: false })
        .limit(10)
    ])

    // Calculate analytics
    const analytics = {
      overview: {
        totalOrders: orders?.length || 0,
        activeOrders: orders?.filter((o: any) => o.status === 'monitoring').length || 0,
        fulfilledOrders: orders?.filter((o: any) => o.status === 'fulfilled').length || 0,
        totalRevenue: payments?.filter((p: any) => p.status === 'released')
          .reduce((sum: number, p: any) => sum + p.merchant_amount, 0) || 0,
        averageOrderValue: orders?.length ? 
          orders.reduce((sum: number, o: any) => sum + o.target_price, 0) / orders.length : 0,
        conversionRate: orders?.length ? 
          (orders.filter((o: any) => o.status === 'fulfilled').length / orders.length) * 100 : 0
      },
      demandByPrice: products?.map((product: any) => {
        const productOrders = orders?.filter((o: any) => o.product_id === product.id) || []
        const demandByPricePoint: Record<number, number> = {}
        productOrders.forEach((order: any) => {
          const pricePoint = Math.round(order.target_price / 50) * 50 // Round to nearest £50
          demandByPricePoint[pricePoint] = (demandByPricePoint[pricePoint] || 0) + 1
        })
        return {
          productId: product.id,
          title: product.title,
          currentPrice: product.current_price,
          demandByPrice: Object.entries(demandByPricePoint).map(([price, count]) => ({
            price: parseInt(price),
            orders: count as number,
            revenue: parseInt(price) * (count as number)
          }))
        }
      }),
      recentActivity,
      trends: {
        daily: [],
        weekly: [],
        monthly: []
      }
    }

    return NextResponse.json({
      success: true,
      analytics
    })
  } catch (error) {
    const errMsg = error instanceof Error ? error.message : 'Unknown error'
    console.error('Analytics error:', errMsg)
    return NextResponse.json(
      { success: false, error: errMsg },
      { status: 500 }
    )
  }
}



================================================
File: app/api/auth/signup/route.ts
================================================
// src/app/api/auth/signup/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(req: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies })
    const { email, password, role, profile } = await req.json()

    // Create auth user
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { role, ...profile }
      }
    })

    if (authError) throw authError

    if (authData.user) {
      // Create profile based on role
      if (role === 'merchant') {
        const { error: profileError } = await supabase
          .from('merchants')
          .insert({
            user_id: authData.user.id,
            name: profile.name,
            email: email,
            company_name: profile.companyName,
            website: profile.website,
            subscription_tier: 'starter',
            subscription_status: 'trial'
          })

        if (profileError) throw profileError
      } else if (role === 'customer') {
        const { error: profileError } = await supabase
          .from('customers')
          .insert({
            user_id: authData.user.id,
            email: email,
            name: profile.name,
            phone: profile.phone,
            preferences: {
              notifications: true,
              email_alerts: true,
              sms_alerts: false
            }
          })

        if (profileError) throw profileError
      }
    }

    return NextResponse.json({ 
      success: true, 
      user: authData.user,
      message: 'Account created successfully'
    })
  } catch (error) {
    // TypeScript: error is unknown, so check for message property
    const errMsg = error instanceof Error ? error.message : 'Unknown error'
    console.error('Signup error:', error)
    return NextResponse.json(
      { success: false, error: errMsg },
      { status: 400 }
    )
  }
}


================================================
File: app/api/buy-orders/route.ts
================================================
import { NextRequest, NextResponse } from 'next/server'
import { 
  getBuyOrders, 
  createBuyOrder, 
  getMerchantStats,
  getCustomerStats,
  updateBuyOrderStatus 
} from '@/lib/database'

// GET /api/buy-orders?merchantId=xxx or customerId=xxx
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const merchantId = searchParams.get('merchantId')
    const customerId = searchParams.get('customerId')
    const getStats = searchParams.get('stats') === 'true'

    if (!merchantId && !customerId) {
      return NextResponse.json(
        { error: 'Either merchantId or customerId is required' },
        { status: 400 }
      )
    }

    if (getStats) {
      if (merchantId) {
        const { data, error } = await getMerchantStats(merchantId)
        if (error) {
          return NextResponse.json(
            { error: 'Failed to fetch merchant statistics' },
            { status: 500 }
          )
        }
        return NextResponse.json({ stats: data })
      } else if (customerId) {
        const { data, error } = await getCustomerStats(customerId)
        if (error) {
          return NextResponse.json(
            { error: 'Failed to fetch customer statistics' },
            { status: 500 }
          )
        }
        return NextResponse.json({ stats: data })
      }
    } else {
      const { data, error } = await getBuyOrders(merchantId || undefined, customerId || undefined)
      if (error) {
        return NextResponse.json(
          { error: 'Failed to fetch buy orders' },
          { status: 500 }
        )
      }
      return NextResponse.json({ buy_orders: data })
    }
  } catch (error) {
    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

// POST /api/buy-orders
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    
    // Validate required fields
    const requiredFields = ['merchantId', 'productId', 'customerEmail', 'targetPrice', 'currentPrice', 'expiryDays']
    for (const field of requiredFields) {
      if (body[field] === undefined || body[field] === null) {
        return NextResponse.json(
          { error: `Missing required field: ${field}` },
          { status: 400 }
        )
      }
    }

    const { data, error } = await createBuyOrder({
      merchantId: body.merchantId,
      productId: body.productId,
      customerEmail: body.customerEmail,
      customerName: body.customerName,
      targetPrice: parseFloat(body.targetPrice),
      currentPrice: parseFloat(body.currentPrice),
      expiryDays: parseInt(body.expiryDays),
      conditionValue: body.conditionValue || {}
    })
    
    if (error) {
      console.error('Create buy order error:', error)
      const errMsg = error instanceof Error ? error.message : String(error)
      return NextResponse.json(
        { error: 'Failed to create buy order', details: errMsg },
        { status: 500 }
      )
    }

    return NextResponse.json(
      { buyOrder: data, message: 'Buy order created successfully' },
      { status: 201 }
    )
  } catch (error) {
    const errMsg = error instanceof Error ? error.message : 'Internal server error'
    console.error('API Error:', errMsg)
    return NextResponse.json(
      { error: errMsg },
      { status: 500 }
    )
  }
}

// PUT /api/buy-orders
export async function PUT(request: NextRequest) {
  try {
    const body = await request.json()
    
    if (!body.id || !body.status) {
      return NextResponse.json(
        { error: 'Missing required fields: id and status' },
        { status: 400 }
      )
    }

    const validStatuses = ['pending', 'monitoring', 'fulfilled', 'cancelled', 'expired']
    if (!validStatuses.includes(body.status)) {
      return NextResponse.json(
        { error: 'Invalid status. Must be one of: ' + validStatuses.join(', ') },
        { status: 400 }
      )
    }

    const { data, error } = await updateBuyOrderStatus(body.id, body.status)
    
    if (error) {
      return NextResponse.json(
        { error: 'Failed to update buy order status' },
        { status: 500 }
      )
    }

    return NextResponse.json(
      { buyOrder: data, message: 'Buy order status updated successfully' }
    )
  } catch (error) {
    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}



================================================
File: app/api/buy-orders/create/route.ts
================================================
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-06-20'
})

export async function POST(req: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies })
    const { 
      productId, 
      targetPrice, 
      expiryDays, 
      paymentMethodId,
      customerInfo 
    } = await req.json()

    // Get current user
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError || !user) {
      throw new Error('Authentication required')
    }

    // Get product details
    const { data: product, error: productError } = await supabase
      .from('products')
      .select(`
        *,
        merchants!inner(id, name, stripe_account_id)
      `)
      .eq('id', productId)
      .single()

    if (productError || !product) {
      throw new Error('Product not found')
    }

    // Calculate fees
    const platformFeeRate = 0.025 // 2.5%
    const totalAmount = Math.round(targetPrice * 100) // Convert to cents
    const platformFee = Math.round(totalAmount * platformFeeRate)
    const merchantAmount = totalAmount - platformFee

    // Get or create customer profile
    let customerId = user.id
    const { data: existingCustomer } = await supabase
      .from('customers')
      .select('id')
      .eq('user_id', user.id)
      .single()

    if (!existingCustomer && customerInfo) {
      const { data: newCustomer, error: customerError } = await supabase
        .from('customers')
        .insert({
          user_id: user.id,
          email: user.email!,
          name: customerInfo.name,
          phone: customerInfo.phone
        })
        .select('id')
        .single()

      if (customerError) throw customerError
      customerId = newCustomer.id
    } else if (existingCustomer) {
      customerId = existingCustomer.id
    }

    // Create payment intent with funds on hold
    const paymentIntent = await stripe.paymentIntents.create({
      amount: totalAmount,
      currency: 'gbp',
      payment_method: paymentMethodId,
      confirmation_method: 'manual',
      capture_method: 'manual', // Hold funds without capturing
      application_fee_amount: platformFee,
      transfer_data: {
        destination: product.merchants.stripe_account_id,
      },
      metadata: {
        product_id: productId,
        merchant_id: product.merchant_id,
        customer_id: customerId,
        target_price: targetPrice.toString(),
        type: 'conditional_buy_order'
      }
    })

    // Confirm payment intent
    const confirmedIntent = await stripe.paymentIntents.confirm(paymentIntent.id)

    if (confirmedIntent.status !== 'requires_capture') {
      throw new Error('Payment authorization failed')
    }

    // Create buy order
    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + expiryDays)

    const { data: buyOrder, error: orderError } = await supabase
      .from('buy_orders')
      .insert({
        merchant_id: product.merchant_id,
        product_id: productId,
        customer_id: customerId,
        customer_email: user.email!,
        customer_name: customerInfo?.name || user.user_metadata?.name,
        target_price: targetPrice,
        current_price: product.current_price,
        status: 'monitoring',
        payment_status: 'authorized',
        expires_at: expiresAt.toISOString(),
        condition_value: {
          payment_intent_id: confirmedIntent.id,
          escrow_amount: totalAmount / 100,
          platform_fee: platformFee / 100
        }
      })
      .select(`
        *,
        products!inner(id, title, image_url, current_price),
        merchants!inner(id, name)
      `)
      .single()

    if (orderError) throw orderError

    // Create escrow payment record
    await supabase
      .from('escrow_payments')
      .insert({
        buy_order_id: buyOrder.id,
        stripe_payment_intent_id: confirmedIntent.id,
        stripe_payment_method_id: paymentMethodId,
        escrow_amount: totalAmount / 100,
        platform_fee: platformFee / 100,
        merchant_amount: merchantAmount / 100,
        status: 'held'
      })

    // Create notifications
    await Promise.all([
      // Notify customer
      supabase.from('notifications').insert({
        user_id: customerId,
        user_type: 'customer',
        buy_order_id: buyOrder.id,
        title: 'Buy Order Created! 🎯',
        message: `Your buy order for ${product.title} at £${targetPrice} is now monitoring for price changes.`,
        type: 'new_order'
      }),
      // Notify merchant
      supabase.from('notifications').insert({
        user_id: product.merchant_id,
        user_type: 'merchant',
        buy_order_id: buyOrder.id,
        title: 'New Buy Order Received 📈',
        message: `New conditional order for ${product.title} at £${targetPrice} (${Math.round((targetPrice / product.current_price) * 100)}% of current price).`,
        type: 'new_order'
      })
    ])

    return NextResponse.json({
      success: true,
      buyOrder,
      paymentIntent: {
        id: confirmedIntent.id,
        status: confirmedIntent.status,
        client_secret: confirmedIntent.client_secret
      }
    })

  } catch (error) {
    const errMsg = error instanceof Error ? error.message : 'Unknown error'
    console.error('Buy order creation error:', error)
    return NextResponse.json(
      { success: false, error: errMsg },
      { status: 500 }
    )
  }
}



================================================
File: app/api/merchants/[id]/stats/route.ts
================================================
import { NextRequest, NextResponse } from 'next/server'
import { getMerchantStats } from '@/lib/database'

// GET /api/merchants/[id]/stats
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const merchantId = params.id

    if (!merchantId) {
      return NextResponse.json(
        { error: 'Merchant ID is required' },
        { status: 400 }
      )
    }

    const { data, error } = await getMerchantStats(merchantId)
    
    if (error) {
      console.error('Merchant stats error:', error)
      return NextResponse.json(
        { error: 'Failed to fetch merchant statistics' },
        { status: 500 }
      )
    }

    return NextResponse.json({ stats: data })
  } catch (error) {
    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}



================================================
File: app/api/products/route.ts
================================================
import { NextRequest, NextResponse } from 'next/server'
import { getProducts, createProduct, updateProductPrice } from '@/lib/database'

// GET /api/products?merchantId=xxx
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const merchantId = searchParams.get('merchantId')

    if (!merchantId) {
      return NextResponse.json(
        { error: 'Merchant ID is required' },
        { status: 400 }
      )
    }

    const { data, error } = await getProducts(merchantId)
    
    if (error) {
      return NextResponse.json(
        { error: 'Failed to fetch products' },
        { status: 500 }
      )
    }

    return NextResponse.json({ products: data })
  } catch (error) {
    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

// POST /api/products
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    
    // Validate required fields
    const requiredFields = ['merchant_id', 'title', 'price', 'current_price']
    for (const field of requiredFields) {
      if (!body[field]) {
        return NextResponse.json(
          { error: `Missing required field: ${field}` },
          { status: 400 }
        )
      }
    }

    const productData = {
      merchant_id: body.merchant_id,
      title: body.title,
      description: body.description || '',
      price: parseFloat(body.price),
      current_price: parseFloat(body.current_price),
      currency: body.currency || 'GBP',
      image_url: body.image_url,
      shopify_product_id: body.shopify_product_id
    }

    const { data, error } = await createProduct(productData)
    
    if (error) {
      return NextResponse.json(
        { error: 'Failed to create product' },
        { status: 500 }
      )
    }

    return NextResponse.json(
      { product: data, message: 'Product created successfully' },
      { status: 201 }
    )
  } catch (error) {
    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

// PUT /api/products (for price updates)
export async function PUT(request: NextRequest) {
  try {
    const body = await request.json()
    
    if (!body.productId || !body.newPrice) {
      return NextResponse.json(
        { error: 'Missing required fields: productId and newPrice' },
        { status: 400 }
      )
    }

    const newPrice = parseFloat(body.newPrice)
    if (isNaN(newPrice) || newPrice <= 0) {
      return NextResponse.json(
        { error: 'Invalid price value' },
        { status: 400 }
      )
    }

    const { data, error } = await updateProductPrice(body.productId, newPrice)
    
    if (error) {
      return NextResponse.json(
        { error: 'Failed to update product price' },
        { status: 500 }
      )
    }

    return NextResponse.json(
      { product: data, message: 'Product price updated successfully' }
    )
  } catch (error) {
    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}



================================================
File: app/api/products/update-price/route.ts
================================================
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(req: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies })
    const { productId, newPrice } = await req.json()

    // Get current user and verify merchant ownership
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError || !user) throw new Error('Authentication required')

    // Verify merchant owns this product
    const { data: product, error: productError } = await supabase
      .from('products')
      .select(`
        *,
        merchants!inner(user_id)
      `)
      .eq('id', productId)
      .single()

    if (productError || !product) throw new Error('Product not found')
    if (product.merchants.user_id !== user.id) throw new Error('Unauthorized')

    // Update product price
    const { error: updateError } = await supabase
      .from('products')
      .update({ current_price: newPrice })
      .eq('id', productId)

    if (updateError) throw updateError

    // Add to price history
    await supabase
      .from('price_history')
      .insert({
        product_id: productId,
        price: newPrice
      })

    // Check for buy orders that can be fulfilled
    const { data: fulfillableOrders } = await supabase
      .from('buy_orders')
      .select(`
        *,
        escrow_payments!inner(*)
      `)
      .eq('product_id', productId)
      .eq('status', 'monitoring')
      .lte('target_price', newPrice)

    // Fulfill eligible orders
    const fulfillmentResults: any[] = []
    for (const order of fulfillableOrders || []) {
      try {
        // Capture payment
        // NOTE: You must import and initialize Stripe here if you want to use it
        // const capturedIntent = await stripe.paymentIntents.capture(
        //   order.escrow_payments[0].stripe_payment_intent_id
        // )
        // For now, just simulate success:
        const capturedIntent = { status: 'succeeded' }

        if (capturedIntent.status === 'succeeded') {
          // Update order status
          await supabase
            .from('buy_orders')
            .update({
              status: 'fulfilled',
              payment_status: 'captured',
              fulfilled_at: new Date().toISOString()
            })
            .eq('id', order.id)

          // Update escrow payment
          await supabase
            .from('escrow_payments')
            .update({
              status: 'released',
              released_at: new Date().toISOString()
            })
            .eq('buy_order_id', order.id)

          // Send fulfillment notifications
          await Promise.all([
            supabase.from('notifications').insert({
              user_id: order.customer_id,
              user_type: 'customer',
              buy_order_id: order.id,
              title: 'Order Fulfilled! 🎉',
              message: `Your buy order has been completed! Payment of £${order.target_price} processed successfully.`,
              type: 'order_fulfilled'
            }),
            supabase.from('notifications').insert({
              user_id: product.merchants.user_id,
              user_type: 'merchant',
              buy_order_id: order.id,
              title: 'Payment Received 💰',
              message: `Buy order payment of £${order.target_price} has been processed.`,
              type: 'order_fulfilled'
            })
          ])

          fulfillmentResults.push({ orderId: order.id, status: 'fulfilled' })
        }
      } catch (fulfillmentError) {
        console.error('Order fulfillment error:', fulfillmentError)
        fulfillmentResults.push({ orderId: order.id, status: 'error', error: fulfillmentError })
      }
    }

    return NextResponse.json({
      success: true,
      newPrice,
      ordersChecked: fulfillableOrders?.length || 0,
      fulfillmentResults
    })

  } catch (error) {
    const errMsg = error instanceof Error ? error.message : 'Unknown error'
    console.error('Price update error:', error)
    return NextResponse.json(
      { success: false, error: errMsg },
      { status: 500 }
    )
  }
}



================================================
File: app/api/stripe/connect/route.ts
================================================
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-06-20'
})

export async function POST(req: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies })
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError || !user) throw new Error('Authentication required')

    // Get merchant record
    const { data: merchant, error: merchantError } = await supabase
      .from('merchants')
      .select('*')
      .eq('user_id', user.id)
      .single()

    if (merchantError || !merchant) throw new Error('Merchant profile not found')

    let accountId = merchant.stripe_account_id

    // Create Stripe Connect account if doesn't exist
    if (!accountId) {
      const account = await stripe.accounts.create({
        type: 'express',
        email: merchant.email,
        capabilities: {
          card_payments: { requested: true },
          transfers: { requested: true },
        },
        metadata: {
          merchant_id: merchant.id,
          limina_user_id: user.id
        }
      })

      accountId = account.id

      // Save account ID
      await supabase
        .from('merchants')
        .update({ stripe_account_id: accountId })
        .eq('id', merchant.id)
    }

    // Create account link for onboarding
    const accountLink = await stripe.accountLinks.create({
      account: accountId,
      refresh_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/payments/refresh`,
      return_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/payments/success`,
      type: 'account_onboarding',
    })

    return NextResponse.json({
      success: true,
      accountId,
      onboardingUrl: accountLink.url
    })

  } catch (error) {
    const errMsg = error instanceof Error ? error.message : 'Unknown error'
    console.error('Stripe Connect error:', error)
    return NextResponse.json(
      { success: false, error: errMsg },
      { status: 500 }
    )
  }
}



================================================
File: app/api/test/route.ts
================================================
import { NextResponse } from 'next/server'

export async function GET() {
  try {
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

    return NextResponse.json({
      status: 'success',
      message: 'API is working',
      environment: {
        supabaseUrl: supabaseUrl ? 'Set' : 'Missing',
        supabaseKey: supabaseKey ? 'Set' : 'Missing',
        nodeEnv: process.env.NODE_ENV
      }
    })
  } catch (error) {
    return NextResponse.json(
      { error: 'Server error', details: (error as Error).message },
      { status: 500 }
    )
  }
}



================================================
File: app/api/webhooks/stripe/route.ts
================================================
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-06-20'
})

export async function POST(req: NextRequest) {
  try {
    const body = await req.text()
    const headersList = await cookies().getAll()
    const signature = headersList.find(h => h.name === 'stripe-signature')?.value
    if (!signature) {
      return NextResponse.json({ error: 'Missing Stripe signature' }, { status: 400 })
    }

    let event: Stripe.Event
    try {
      event = stripe.webhooks.constructEvent(
        body,
        signature,
        process.env.STRIPE_WEBHOOK_SECRET!
      )
    } catch (error) {
      const errMsg = error instanceof Error ? error.message : 'Unknown error'
      console.error('Webhook signature verification failed:', errMsg)
      return NextResponse.json({ error: 'Invalid signature' }, { status: 400 })
    }

    const supabase = createRouteHandlerClient({ cookies })

    switch (event.type) {
      case 'payment_intent.succeeded': {
        const paymentIntent = event.data.object as Stripe.PaymentIntent
        if (paymentIntent.metadata.type === 'conditional_buy_order') {
          await supabase
            .from('buy_orders')
            .update({ payment_status: 'captured' })
            .eq('id', paymentIntent.metadata.buy_order_id)
        }
        break
      }
      case 'account.updated': {
        const account = event.data.object as Stripe.Account
        if (account.charges_enabled && account.payouts_enabled) {
          await supabase
            .from('merchants')
            .update({ stripe_onboarding_complete: true })
            .eq('stripe_account_id', account.id)
        }
        break
      }
      default:
        console.log(`Unhandled event type: ${event.type}`)
    }

    return NextResponse.json({ received: true })
  } catch (error) {
    const errMsg = error instanceof Error ? error.message : 'Webhook processing failed'
    console.error('Webhook error:', errMsg)
    return NextResponse.json(
      { error: errMsg },
      { status: 500 }
    )
  }
}



================================================
File: app/customer/page.tsx
================================================
'use client'

import React, { useState, useEffect } from 'react'
import Link from 'next/link'
import { Logo } from '@/components/Logo'
import { ShoppingCart, TrendingDown, Clock, CheckCircle2, XCircle, Activity, DollarSign } from 'lucide-react'

interface Product {
  id: string
  title: string
  current_price: number
  price: number
  currency: string
  image_url?: string
}

interface BuyOrder {
  id: string
  target_price: number
  current_price: number
  status: string
  created_at: string
  expires_at: string
  fulfilled_at?: string
  products?: Product
}

export default function CustomerDashboard() {
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [buyOrders, setBuyOrders] = useState<BuyOrder[]>([])
  
  // Using Mike Chen's customer ID from our seed data (he has multiple orders)
  const CUSTOMER_ID = '223e4567-e89b-12d3-a456-426614174002'

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true)
        
        // Fetch buy orders for this customer
        const response = await fetch(`/api/buy-orders?customerId=${CUSTOMER_ID}`)
        const data = await response.json()
        
        if (data.buy_orders) {
          setBuyOrders(data.buy_orders)
        }
        
        setLoading(false)
      } catch (err) {
        console.error('Error fetching data:', err)
        setError('Failed to load your buy orders')
        setLoading(false)
      }
    }

    fetchData()
  }, [])

  const getStatusBadge = (status: string) => {
    const badges = {
      monitoring: { class: 'bg-blue-100 text-blue-800', icon: Activity },
      fulfilled: { class: 'bg-green-100 text-green-800', icon: CheckCircle2 },
      pending: { class: 'bg-yellow-100 text-yellow-800', icon: Clock },
      expired: { class: 'bg-gray-100 text-gray-800', icon: XCircle },
      cancelled: { class: 'bg-red-100 text-red-800', icon: XCircle }
    }
    return badges[status as keyof typeof badges] || { class: 'bg-gray-100 text-gray-800', icon: Clock }
  }

  const formatCurrency = (amount: number) => `£${amount.toFixed(2)}`
  const formatDate = (dateString: string) => new Date(dateString).toLocaleDateString()
  const calculateSavings = (target: number, current: number) => current - target

  const activeOrders = buyOrders.filter(order => order.status === 'monitoring')
  const fulfilledOrders = buyOrders.filter(order => order.status === 'fulfilled')
  const totalSavings = fulfilledOrders.reduce((sum, order) => sum + calculateSavings(order.target_price, order.current_price), 0)

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading your buy orders...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-500 text-xl mb-4">❌ Error</div>
          <p className="text-gray-600 mb-4">{error}</p>
          <button 
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Retry
          </button>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white">
      {/* Navigation */}
      <nav className="border-b border-gray-200 bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center space-x-2">
              <Logo />
              <h1 className="text-2xl font-bold text-blue-600">Limina</h1>
            </div>
            <div className="flex items-center space-x-4">
              <span className="text-sm text-gray-600">Customer Dashboard</span>
              <Link href="/" className="text-gray-600 hover:text-blue-600">
                ← Back to Site
              </Link>
            </div>
          </div>
        </div>
      </nav>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="mb-8">
          <h2 className="text-3xl font-bold text-gray-900">Your Buy Orders</h2>
          <p className="text-gray-600 mt-2">
            Track your conditional purchases and see when your price targets are met
          </p>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <Activity className="h-8 w-8 text-blue-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">Active Orders</p>
                <p className="text-2xl font-bold text-gray-900">{activeOrders.length}</p>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <CheckCircle2 className="h-8 w-8 text-green-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">Fulfilled Orders</p>
                <p className="text-2xl font-bold text-gray-900">{fulfilledOrders.length}</p>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <DollarSign className="h-8 w-8 text-green-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">Total Savings</p>
                <p className="text-2xl font-bold text-green-600">{formatCurrency(totalSavings)}</p>
              </div>
            </div>
          </div>
        </div>

        {/* Active Orders */}
        {activeOrders.length > 0 && (
          <div className="bg-white rounded-lg border border-gray-200 mb-8">
            <div className="px-6 py-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900 flex items-center">
                <Activity className="h-5 w-5 mr-2 text-blue-600" />
                Active Monitoring Orders
              </h3>
              <p className="text-sm text-gray-600 mt-1">We're watching these products for you</p>
            </div>
            
            <div className="p-6 space-y-4">
              {activeOrders.map((order) => {
                const isClose = order.current_price <= order.target_price * 1.1 // Within 10%
                const probability = Math.max(30, Math.min(95, Math.round((order.current_price - order.target_price) / order.current_price * 100 + 60)))
                
                return (
                  <div key={order.id} className={`border rounded-lg p-4 ${isClose ? 'border-blue-300 bg-blue-50' : 'border-gray-200'}`}>
                    <div className="flex items-start justify-between">
                      <div className="flex items-center space-x-4">
                        {order.products?.image_url && (
                          <img 
                            className="h-16 w-16 rounded-lg object-cover" 
                            src={order.products.image_url} 
                            alt={order.products.title} 
                          />
                        )}
                        <div>
                          <h4 className="font-semibold text-gray-900 text-lg">{order.products?.title}</h4>
                          <p className="text-sm text-gray-600">Target: {formatCurrency(order.target_price)} | Current: {formatCurrency(order.current_price)}</p>
                          <p className="text-sm text-gray-500">Created: {formatDate(order.created_at)}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <span className={`inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800`}>
                          Monitoring
                        </span>
                        <p className="text-sm text-blue-600 mt-2 font-medium">
                          {probability}% probability based on trends
                        </p>
                      </div>
                    </div>
                    
                    {/* Progress bar */}
                    <div className="mt-4">
                      <div className="flex justify-between text-sm mb-1">
                        <span>Price Progress</span>
                        <span>{formatCurrency(Math.abs(order.current_price - order.target_price))} to go</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div 
                          className={`h-2 rounded-full ${isClose ? 'bg-blue-500' : 'bg-gray-400'}`}
                          style={{
                            width: `${Math.min(100, Math.max(20, (order.target_price / order.current_price) * 100))}%`
                          }}
                        ></div>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        )}

        {/* Fulfilled Orders */}
        {fulfilledOrders.length > 0 && (
          <div className="bg-white rounded-lg border border-gray-200 mb-8">
            <div className="px-6 py-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900 flex items-center">
                <CheckCircle2 className="h-5 w-5 mr-2 text-green-600" />
                Completed Purchases
              </h3>
              <p className="text-sm text-gray-600 mt-1">Your successful buy orders and savings</p>
            </div>
            
            <div className="p-6 space-y-4">
              {fulfilledOrders.map((order) => {
                const savings = calculateSavings(order.target_price, order.current_price)
                const savingsPercent = Math.round((savings / order.current_price) * 100)
                
                return (
                  <div key={order.id} className="border border-green-200 rounded-lg p-4 bg-green-50">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-4">
                        {order.products?.image_url && (
                          <img 
                            className="h-16 w-16 rounded-lg object-cover" 
                            src={order.products.image_url} 
                            alt={order.products.title} 
                          />
                        )}
                        <div>
                          <h4 className="font-semibold text-gray-900 text-lg">{order.products?.title}</h4>
                          <p className="text-sm text-gray-600">Purchased at: {formatCurrency(order.target_price)}</p>
                          <p className="text-sm text-gray-500">Fulfilled: {order.fulfilled_at ? formatDate(order.fulfilled_at) : 'Recently'}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <span className="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                          ✓ Complete
                        </span>
                        <p className="text-sm text-green-600 mt-2 font-bold">
                          Saved {formatCurrency(savings)} ({savingsPercent}%)
                        </p>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        )}

        {/* All Orders Table */}
        <div className="bg-white rounded-lg border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900">All Buy Orders</h3>
            <p className="text-sm text-gray-600 mt-1">Complete history of your conditional purchases</p>
          </div>
          
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Product
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Target Price
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Current Price
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Created
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {buyOrders.length > 0 ? buyOrders.map((order) => {
                  const status = getStatusBadge(order.status)
                  const StatusIcon = status.icon
                  
                  return (
                    <tr key={order.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center">
                          {order.products?.image_url && (
                            <img 
                              className="h-10 w-10 rounded-lg object-cover mr-3" 
                              src={order.products.image_url} 
                              alt={order.products.title} 
                            />
                          )}
                          <div className="text-sm font-medium text-gray-900">
                            {order.products?.title || 'Product'}
                          </div>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm font-medium text-green-600">
                          {formatCurrency(order.target_price)}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm text-gray-900">
                          {formatCurrency(order.current_price)}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${status.class}`}>
                          <StatusIcon className="w-3 h-3 mr-1" />
                          {order.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {formatDate(order.created_at)}
                      </td>
                    </tr>
                  )
                }) : (
                  <tr>
                    <td colSpan={5} className="px-6 py-4 text-center text-gray-500">
                      No buy orders found. Create your first buy order on our landing page!
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Quick Links */}
        <div className="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold text-blue-800 mb-4">Quick Actions</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <Link href="/dashboard" className="text-blue-600 hover:text-blue-800 flex items-center">
              <ShoppingCart className="w-4 h-4 mr-2" />
              Merchant View
            </Link>
            <Link href="/" className="text-blue-600 hover:text-blue-800 flex items-center">
              <TrendingDown className="w-4 h-4 mr-2" />
              Create Buy Order
            </Link>
            <a href="http://127.0.0.1:54323" target="_blank" className="text-blue-600 hover:text-blue-800 flex items-center">
              <Activity className="w-4 h-4 mr-2" />
              Database View
            </a>
            <button className="text-blue-600 hover:text-blue-800 flex items-center" onClick={() => window.location.reload()}>
              <Clock className="w-4 h-4 mr-2" />
              Refresh Orders
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}



================================================
File: app/dashboard/page.tsx
================================================
'use client'

import React, { useState, useEffect } from 'react'
import Link from 'next/link'
import { Logo } from '@/components/Logo'
import { ShoppingCart, TrendingUp, Users, DollarSign, Eye, Activity, Clock, CheckCircle2 } from 'lucide-react'

interface Product {
  id: string
  title: string
  current_price: number
  price: number
  currency: string
  image_url?: string
}

interface BuyOrder {
  id: string
  customer_name: string
  customer_email: string
  target_price: number
  current_price: number
  status: string
  created_at: string
  expires_at: string
  products?: Product
}

interface Stats {
  total: number
  monitoring: number
  fulfilled: number
  pending: number
  cancelled: number
  totalRevenue: number
  avgDiscount: number
  conversionRate: number
}

export default function MerchantDashboard() {
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [buyOrders, setBuyOrders] = useState<BuyOrder[]>([])
  const [stats, setStats] = useState<Stats | null>(null)
  const [products, setProducts] = useState<Product[]>([])

  // Using the TechStore merchant ID from our seed data
  const MERCHANT_ID = '123e4567-e89b-12d3-a456-426614174000'

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true)
        
        // Fetch buy orders for this merchant
        const ordersResponse = await fetch(`/api/buy-orders?merchantId=${MERCHANT_ID}`)
        const ordersData = await ordersResponse.json()
        
        // Fetch products for this merchant
        const productsResponse = await fetch(`/api/products?merchantId=${MERCHANT_ID}`)
        const productsData = await productsResponse.json()
        
        // Fetch stats for this merchant
        const statsResponse = await fetch(`/api/merchants/${MERCHANT_ID}/stats`)
        const statsData = await statsResponse.json()

        if (ordersData.buy_orders) setBuyOrders(ordersData.buy_orders)
        if (productsData.products) setProducts(productsData.products)
        if (statsData.stats) setStats(statsData.stats)
        
        setLoading(false)
      } catch (err) {
        console.error('Error fetching data:', err)
        setError('Failed to load dashboard data')
        setLoading(false)
      }
    }

    fetchData()
  }, [])

  const getStatusBadge = (status: string) => {
    const badges = {
      monitoring: 'bg-blue-100 text-blue-800',
      fulfilled: 'bg-green-100 text-green-800',
      pending: 'bg-yellow-100 text-yellow-800',
      expired: 'bg-gray-100 text-gray-800',
      cancelled: 'bg-red-100 text-red-800'
    }
    return badges[status as keyof typeof badges] || 'bg-gray-100 text-gray-800'
  }

  const formatCurrency = (amount: number) => `£${amount.toFixed(2)}`
  const formatDate = (dateString: string) => new Date(dateString).toLocaleDateString()

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading merchant dashboard...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-500 text-xl mb-4">❌ Error</div>
          <p className="text-gray-600 mb-4">{error}</p>
          <button 
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Retry
          </button>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white">
      {/* Navigation */}
      <nav className="border-b border-gray-200 bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center space-x-2">
              <Logo />
              <h1 className="text-2xl font-bold text-blue-600">Limina</h1>
            </div>
            <div className="flex items-center space-x-4">
              <span className="text-sm text-gray-600">TechStore Merchant Dashboard</span>
              <Link href="/" className="text-gray-600 hover:text-blue-600">
                ← Back to Site
              </Link>
            </div>
          </div>
        </div>
      </nav>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="mb-8">
          <h2 className="text-3xl font-bold text-gray-900">Merchant Dashboard</h2>
          <p className="text-gray-600 mt-2">
            Track buy orders, analyze demand, and optimize your pricing strategy
          </p>
        </div>

        {/* Stats Cards */}
        {stats && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <ShoppingCart className="h-8 w-8 text-blue-600" />
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Total Orders</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.total}</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <Activity className="h-8 w-8 text-green-600" />
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Active Monitoring</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.monitoring}</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <DollarSign className="h-8 w-8 text-purple-600" />
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Total Revenue</p>
                  <p className="text-2xl font-bold text-gray-900">{formatCurrency(stats.totalRevenue)}</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <TrendingUp className="h-8 w-8 text-orange-600" />
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Conversion Rate</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.conversionRate}%</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Buy Orders Table */}
        <div className="bg-white rounded-lg border border-gray-200 mb-8">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900 flex items-center">
              <Eye className="h-5 w-5 mr-2 text-blue-600" />
              Active Buy Orders
            </h3>
            <p className="text-sm text-gray-600 mt-1">Monitor customer demand and price targets</p>
          </div>
          
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Product
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Customer
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Target Price
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Current Price
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Created
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {buyOrders.length > 0 ? buyOrders.map((order) => (
                  <tr key={order.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        {order.products?.image_url && (
                          <img 
                            className="h-10 w-10 rounded-lg object-cover mr-3" 
                            src={order.products.image_url} 
                            alt={order.products.title} 
                          />
                        )}
                        <div>
                          <div className="text-sm font-medium text-gray-900">
                            {order.products?.title || 'Product'}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{order.customer_name}</div>
                      <div className="text-sm text-gray-500">{order.customer_email}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm font-medium text-green-600">
                        {formatCurrency(order.target_price)}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">
                        {formatCurrency(order.current_price)}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadge(order.status)}`}>
                        {order.status}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {formatDate(order.created_at)}
                    </td>
                  </tr>
                )) : (
                  <tr>
                    <td colSpan={6} className="px-6 py-4 text-center text-gray-500">
                      No buy orders found
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Products Summary */}
        <div className="bg-white rounded-lg border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900 flex items-center">
              <ShoppingCart className="h-5 w-5 mr-2 text-blue-600" />
              Your Products
            </h3>
            <p className="text-sm text-gray-600 mt-1">Product catalog with current pricing</p>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6">
            {products.map((product) => (
              <div key={product.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                {product.image_url && (
                  <img 
                    className="w-full h-32 object-cover rounded-md mb-3" 
                    src={product.image_url} 
                    alt={product.title} 
                  />
                )}
                <h4 className="font-medium text-gray-900 mb-2">{product.title}</h4>
                <div className="flex justify-between items-center">
                  <span className="text-lg font-bold text-blue-600">
                    {formatCurrency(product.current_price)}
                  </span>
                  {product.current_price !== product.price && (
                    <span className="text-sm text-gray-500 line-through">
                      {formatCurrency(product.price)}
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Quick Links */}
        <div className="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold text-blue-800 mb-4">Quick Actions</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="http://127.0.0.1:54323" target="_blank" className="text-blue-600 hover:text-blue-800 flex items-center">
              <Users className="w-4 h-4 mr-2" />
              Supabase Studio
            </a>
            <Link href="/customer" className="text-blue-600 hover:text-blue-800 flex items-center">
              <ShoppingCart className="w-4 h-4 mr-2" />
              Customer View
            </Link>
            <Link href="/" className="text-blue-600 hover:text-blue-800 flex items-center">
              <Eye className="w-4 h-4 mr-2" />
              Landing Page
            </Link>
            <button className="text-blue-600 hover:text-blue-800 flex items-center" onClick={() => window.location.reload()}>
              <Activity className="w-4 h-4 mr-2" />
              Refresh Data
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}



================================================
File: components/Logo.tsx
================================================
'use client'

import React, { useRef } from 'react'

export function Logo() {
  const logoRef = useRef<HTMLDivElement>(null)

  const handleLogoClick = () => {
    if (!logoRef.current) return
    
    const check = logoRef.current.querySelector('#header-check') as SVGPathElement
    const coin = logoRef.current.querySelector('#header-coin') as SVGCircleElement
    
    if (check && coin) {
      // Reset animations
      check.style.animation = 'none'
      coin.style.animation = 'none'
      
      // Trigger reflow
      void (check as unknown as HTMLElement).offsetWidth
      void (coin as unknown as HTMLElement).offsetWidth
      
      // Restart animations
      check.style.animation = 'draw-check 0.8s ease-out forwards'
      coin.style.animation = 'coin-emerge-spin 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.25s forwards'
    }
  }

  return (
    <div 
      ref={logoRef}
      className="limina-logo cursor-pointer" 
      id="nav-logo"
      onClick={handleLogoClick}
    >
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <rect width="100" height="100" rx="25" fill="#10344C"/>
        <path
          id="header-check"
          d="M15 55 L40 80 L85 22"
          stroke="#FFFFFF"
          strokeWidth="12"
          strokeLinecap="round"
          strokeLinejoin="round"
          fill="none"
        />
        <circle
          id="header-coin"
          cx="39"
          cy="50"
          r="9"
          fill="#FACC15"
          stroke="#F59E0B"
          strokeWidth="2"
        />
      </svg>
    </div>
  )
}



================================================
File: components/index.ts
================================================
// Export all components from a single location for cleaner imports
export { Logo } from './Logo'

// You can add more components here as you build them
// export { Navigation } from './Navigation'
// export { Footer } from './Footer'
// export { Card } from './Card'



================================================
File: lib/auth.ts
================================================
// src/lib/auth.ts - Enhanced Authentication System
import { supabase } from './supabase'
import { User } from '@supabase/supabase-js'

export type UserRole = 'merchant' | 'customer' | 'admin'

export interface LiminaUser extends User {
  role: UserRole
  profile: MerchantProfile | CustomerProfile
}

export interface MerchantProfile {
  id: string
  name: string
  email: string
  company_name: string
  website?: string
  shopify_domain?: string
  stripe_account_id?: string
  subscription_tier: 'starter' | 'professional' | 'enterprise'
  created_at: string
}

export interface CustomerProfile {
  id: string
  name: string
  email: string
  phone?: string
  preferences: {
    notifications: boolean
    email_alerts: boolean
    sms_alerts: boolean
  }
  created_at: string
}

// Enhanced authentication functions
export class AuthService {
  
  // Sign up as merchant
  static async signUpMerchant(data: {
    email: string
    password: string
    companyName: string
    name: string
    website?: string
  }) {
    try {
      // Create auth user
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: data.email,
        password: data.password,
        options: {
          data: {
            role: 'merchant',
            name: data.name,
            company_name: data.companyName
          }
        }
      })

      if (authError) throw authError

      // Create merchant profile
      if (authData.user) {
        const { error: profileError } = await supabase
          .from('merchants')
          .insert({
            id: authData.user.id,
            name: data.name,
            email: data.email,
            company_name: data.companyName,
            website: data.website,
            subscription_tier: 'starter'
          })

        if (profileError) throw profileError
      }

      return { data: authData, error: null }
    } catch (error) {
      return { data: null, error }
    }
  }

  // Sign up as customer
  static async signUpCustomer(data: {
    email: string
    password: string
    name: string
    phone?: string
  }) {
    try {
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: data.email,
        password: data.password,
        options: {
          data: {
            role: 'customer',
            name: data.name
          }
        }
      })

      if (authError) throw authError

      if (authData.user) {
        const { error: profileError } = await supabase
          .from('customers')
          .insert({
            id: authData.user.id,
            email: data.email,
            name: data.name,
            phone: data.phone,
            preferences: {
              notifications: true,
              email_alerts: true,
              sms_alerts: false
            }
          })

        if (profileError) throw profileError
      }

      return { data: authData, error: null }
    } catch (error) {
      return { data: null, error }
    }
  }

  // Get current user with profile
  static async getCurrentUser(): Promise<{ user: LiminaUser | null, error: any }> {
    try {
      const { data: { user }, error } = await supabase.auth.getUser()
      
      if (error || !user) return { user: null, error }

      const role = user.user_metadata.role as UserRole
      let profile = null

      if (role === 'merchant') {
        const { data } = await supabase
          .from('merchants')
          .select('*')
          .eq('id', user.id)
          .single()
        profile = data
      } else if (role === 'customer') {
        const { data } = await supabase
          .from('customers')
          .select('*')
          .eq('id', user.id)
          .single()
        profile = data
      }

      return {
        user: { ...user, role, profile } as LiminaUser,
        error: null
      }
    } catch (error) {
      return { user: null, error }
    }
  }

  // Role-based route protection
  static async requireRole(requiredRole: UserRole): Promise<boolean> {
    const { user } = await this.getCurrentUser()
    return user?.role === requiredRole
  }

  // Multi-tenant data access
  static async getMerchantProducts(merchantId: string) {
    const { user } = await this.getCurrentUser()
    
    // Only allow merchants to access their own products
    if (user?.role === 'merchant' && user.id !== merchantId) {
      throw new Error('Unauthorized: Cannot access other merchant data')
    }

    const { data, error } = await supabase
      .from('products')
      .select('*')
      .eq('merchant_id', merchantId)

    return { data, error }
  }

  // Sign out
  static async signOut() {
    return await supabase.auth.signOut()
  }
}

// React Hook for authentication
import { useState, useEffect } from 'react'

export function useAuth() {
  const [user, setUser] = useState<LiminaUser | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // Get initial user
    AuthService.getCurrentUser().then(({ user }) => {
      setUser(user)
      setLoading(false)
    })

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (session?.user) {
          const { user } = await AuthService.getCurrentUser()
          setUser(user)
        } else {
          setUser(null)
        }
        setLoading(false)
      }
    )

    return () => subscription.unsubscribe()
  }, [])

  return {
    user,
    loading,
    isMerchant: user?.role === 'merchant',
    isCustomer: user?.role === 'customer',
    signUpMerchant: AuthService.signUpMerchant,
    signUpCustomer: AuthService.signUpCustomer,
    signOut: AuthService.signOut
  }
}

// Enhanced RLS policies (SQL)
/*
-- Enhanced Row Level Security

-- Merchants can only access their own data
CREATE POLICY "merchants_own_data" ON merchants
  FOR ALL USING (auth.uid()::text = id);

CREATE POLICY "merchants_own_products" ON products
  FOR ALL USING (auth.uid()::text = merchant_id);

CREATE POLICY "merchants_own_orders" ON buy_orders
  FOR ALL USING (auth.uid()::text = merchant_id);

-- Customers can only access their own data
CREATE POLICY "customers_own_data" ON customers
  FOR ALL USING (auth.uid()::text = id);

CREATE POLICY "customers_own_orders" ON buy_orders
  FOR ALL USING (auth.uid()::text = customer_id);

-- Admins can access everything (add admin role check)
CREATE POLICY "admin_full_access" ON merchants
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.uid() = id 
      AND raw_user_meta_data->>'role' = 'admin'
    )
  );

-- Enable RLS on all tables
ALTER TABLE merchants ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE buy_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
*/


================================================
File: lib/database.ts
================================================
import { supabase } from './supabase'

// Basic types for our data
export type Merchant = {
  id: string
  name: string
  email: string
  shopify_domain?: string | null
  shopify_access_token?: string | null
  created_at: string
  updated_at: string
}

export type Customer = {
  id: string
  email: string
  name?: string | null
  created_at: string
  updated_at: string
}

export type Product = {
  id: string
  merchant_id: string
  title: string
  description?: string | null
  price: number
  current_price: number
  currency: string
  image_url?: string | null
  shopify_product_id?: string | null
  created_at: string
  updated_at: string
}

export type BuyOrder = {
  id: string
  merchant_id: string
  product_id: string
  customer_id: string
  customer_email: string
  customer_name?: string | null
  target_price: number
  current_price: number
  currency: string
  status: 'pending' | 'monitoring' | 'fulfilled' | 'cancelled' | 'expired'
  condition_type: 'price' | 'inventory' | 'date'
  condition_value: Record<string, unknown>
  expires_at: string
  fulfilled_at?: string | null
  created_at: string
  updated_at: string
  products?: Product
  customers?: Customer
}

// Merchant Functions
export async function getMerchant(id: string) {
  try {
    const { data, error } = await supabase
      .from('merchants')
      .select('*')
      .eq('id', id)
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error fetching merchant:', error)
    return { data: null, error }
  }
}

// Customer Functions
export async function getCustomer(email: string) {
  try {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .eq('email', email)
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error fetching customer:', error)
    return { data: null, error }
  }
}

export async function getOrCreateCustomer(email: string, name?: string) {
  try {
    // Try to get existing customer
    const { data: existingCustomer } = await getCustomer(email)
    
    if (existingCustomer) {
      return { data: existingCustomer, error: null }
    }
    
    // Create new customer if doesn't exist
    const { data, error } = await supabase
      .from('customers')
      .insert({ email, name })
      .select()
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error creating customer:', error)
    return { data: null, error }
  }
}

// Product Functions
export async function getProducts(merchantId: string) {
  try {
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .eq('merchant_id', merchantId)
      .order('created_at', { ascending: false })

    return { data, error }
  } catch (error: unknown) {
    console.error('Error fetching products:', error)
    return { data: null, error }
  }
}

export async function createProduct(product: {
  merchant_id: string
  title: string
  description?: string | null
  price: number
  current_price: number
  currency?: string
  image_url?: string | null
  shopify_product_id?: string | null
}) {
  try {
    const { data, error } = await supabase
      .from('products')
      .insert(product)
      .select()
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error creating product:', error)
    return { data: null, error }
  }
}

export async function updateProductPrice(productId: string, newPrice: number) {
  try {
    // Insert price history
    await supabase
      .from('price_history')
      .insert({
        product_id: productId,
        price: newPrice
      })

    // Update product current_price
    const { data, error } = await supabase
      .from('products')
      .update({ current_price: newPrice })
      .eq('id', productId)
      .select()
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error updating product price:', error)
    return { data: null, error }
  }
}

// Buy Order Functions
export async function getBuyOrders(merchantId?: string, customerId?: string) {
  try {
    let query = supabase
      .from('buy_orders')
      .select(`
        *,
        products (
          id,
          title,
          price,
          current_price,
          currency,
          image_url
        ),
        customers (
          id,
          email,
          name
        )
      `)
      .order('created_at', { ascending: false })

    if (merchantId) {
      query = query.eq('merchant_id', merchantId)
    }
    
    if (customerId) {
      query = query.eq('customer_id', customerId)
    }

    const { data, error } = await query
    return { data, error }
  } catch (error: unknown) {
    console.error('Error fetching buy orders:', error)
    return { data: null, error }
  }
}

export async function createBuyOrder(orderData: {
  merchantId: string
  productId: string
  customerEmail: string
  customerName?: string
  targetPrice: number
  currentPrice: number
  expiryDays: number
  conditionValue?: Record<string, unknown>
}) {
  try {
    // Get or create customer
    const { data: customer, error: customerError } = await getOrCreateCustomer(
      orderData.customerEmail, 
      orderData.customerName
    )
    
    if (customerError || !customer) {
      throw new Error('Failed to create customer')
    }

    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + orderData.expiryDays)

    const buyOrder = {
      merchant_id: orderData.merchantId,
      product_id: orderData.productId,
      customer_id: customer.id,
      customer_email: orderData.customerEmail,
      customer_name: orderData.customerName,
      target_price: orderData.targetPrice,
      current_price: orderData.currentPrice,
      status: 'monitoring' as const,
      condition_type: 'price' as const,
      condition_value: orderData.conditionValue || {},
      expires_at: expiresAt.toISOString()
    }

    const { data, error } = await supabase
      .from('buy_orders')
      .insert(buyOrder)
      .select(`
        *,
        products (
          id,
          title,
          price,
          current_price,
          currency,
          image_url
        )
      `)
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error creating buy order:', error)
    return { data: null, error }
  }
}

export async function updateBuyOrderStatus(
  id: string, 
  status: 'pending' | 'monitoring' | 'fulfilled' | 'cancelled' | 'expired'
) {
  try {
    const updateData: Record<string, unknown> = { status }
    
    if (status === 'fulfilled') {
      updateData.fulfilled_at = new Date().toISOString()
    }

    const { data, error } = await supabase
      .from('buy_orders')
      .update(updateData)
      .eq('id', id)
      .select()
      .single()

    return { data, error }
  } catch (error: unknown) {
    console.error('Error updating buy order status:', error)
    return { data: null, error }
  }
}

// Analytics Functions
export async function getMerchantStats(merchantId: string) {
  try {
    const { data: orders, error } = await supabase
      .from('buy_orders')
      .select('status, target_price, current_price')
      .eq('merchant_id', merchantId)

    if (error) throw error

    const stats = {
      total: orders?.length || 0,
      monitoring: orders?.filter(order => order.status === 'monitoring').length || 0,
      fulfilled: orders?.filter(order => order.status === 'fulfilled').length || 0,
      pending: orders?.filter(order => order.status === 'pending').length || 0,
      cancelled: orders?.filter(order => order.status === 'cancelled').length || 0,
      totalRevenue: orders
        ?.filter(order => order.status === 'fulfilled')
        .reduce((sum, order) => sum + Number(order.target_price), 0) || 0,
      avgDiscount: 0,
      conversionRate: 0
    }

    // Calculate average discount and conversion rate
    const fulfilledOrders = orders?.filter(order => order.status === 'fulfilled') || []
    if (fulfilledOrders.length > 0) {
      const totalDiscount = fulfilledOrders.reduce((sum, order) => {
        const discount = ((Number(order.current_price) - Number(order.target_price)) / Number(order.current_price)) * 100
        return sum + discount
      }, 0)
      
      stats.avgDiscount = Math.round(totalDiscount / fulfilledOrders.length)
      stats.conversionRate = Math.round((fulfilledOrders.length / (orders?.length || 1)) * 100)
    }

    return { data: stats, error: null }
  } catch (error: unknown) {
    console.error('Error fetching merchant stats:', error)
    return { data: null, error }
  }
}

export async function getCustomerStats(customerId: string) {
  try {
    const { data: orders, error } = await supabase
      .from('buy_orders')
      .select('status, target_price, current_price')
      .eq('customer_id', customerId)

    if (error) throw error

    const stats = {
      total: orders?.length || 0,
      monitoring: orders?.filter(order => order.status === 'monitoring').length || 0,
      fulfilled: orders?.filter(order => order.status === 'fulfilled').length || 0,
      totalSavings: orders
        ?.filter(order => order.status === 'fulfilled')
        .reduce((sum, order) => sum + (Number(order.current_price) - Number(order.target_price)), 0) || 0
    }

    return { data: stats, error: null }
  } catch (error: unknown) {
    console.error('Error fetching customer stats:', error)
    return { data: null, error }
  }
}

// Real-time subscriptions
export function subscribeToBuyOrders(merchantId: string, callback: (payload: Record<string, unknown>) => void) {
  return supabase
    .channel('buy_orders_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'buy_orders',
        filter: `merchant_id=eq.${merchantId}`
      },
      callback
    )
    .subscribe()
}

export function subscribeToCustomerOrders(customerId: string, callback: (payload: Record<string, unknown>) => void) {
  return supabase
    .channel('customer_orders_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'buy_orders',
        filter: `customer_id=eq.${customerId}`
      },
      callback
    )
    .subscribe()
}



================================================
File: lib/payments.ts
================================================
// src/lib/payments.ts - Comprehensive Payment System
import Stripe from 'stripe'
import { supabase } from './supabase'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-06-20'
})

export interface PaymentIntent {
  id: string
  amount: number
  currency: string
  status: string
  client_secret: string
  metadata: {
    buy_order_id: string
    merchant_id: string
    customer_id: string
  }
}

export interface EscrowPayment {
  buy_order_id: string
  stripe_payment_intent_id: string
  stripe_payment_method_id: string
  escrow_amount: number
  platform_fee: number
  merchant_amount: number
  status: 'held' | 'released' | 'refunded'
  held_at: string
  released_at?: string
  refunded_at?: string
}

export class PaymentService {
  
  // Create buy order with payment commitment
  static async createBuyOrderWithPayment(orderData: {
    merchantId: string
    productId: string
    customerId: string
    targetPrice: number
    paymentMethodId: string
    expiryDays: number
  }) {
    try {
      // Calculate amounts
      const platformFeeRate = 0.025 // 2.5% platform fee
      const platformFee = Math.round(orderData.targetPrice * platformFeeRate * 100) // in cents
      const merchantAmount = Math.round(orderData.targetPrice * 100) - platformFee
      const totalAmount = Math.round(orderData.targetPrice * 100)

      // Get merchant's Stripe Connect account
      const { data: merchant } = await supabase
        .from('merchants')
        .select('stripe_account_id')
        .eq('id', orderData.merchantId)
        .single()

      if (!merchant?.stripe_account_id) {
        throw new Error('Merchant has not connected their Stripe account')
      }

      // Create payment intent with funds on hold
      const paymentIntent = await stripe.paymentIntents.create({
        amount: totalAmount,
        currency: 'gbp',
        payment_method: orderData.paymentMethodId,
        confirmation_method: 'manual',
        capture_method: 'manual', // Hold funds without capturing
        application_fee_amount: platformFee,
        transfer_data: {
          destination: merchant.stripe_account_id,
        },
        metadata: {
          buy_order_id: 'temp', // Will be updated after buy order creation
          merchant_id: orderData.merchantId,
          customer_id: orderData.customerId,
          type: 'conditional_buy_order'
        }
      })

      // Confirm payment intent to authorize the payment
      const confirmedIntent = await stripe.paymentIntents.confirm(paymentIntent.id)

      if (confirmedIntent.status !== 'requires_capture') {
        throw new Error('Payment authorization failed')
      }

      // Create buy order in database
      const expiresAt = new Date()
      expiresAt.setDate(expiresAt.getDate() + orderData.expiryDays)

      const { data: buyOrder, error: orderError } = await supabase
        .from('buy_orders')
        .insert({
          merchant_id: orderData.merchantId,
          product_id: orderData.productId,
          customer_id: orderData.customerId,
          target_price: orderData.targetPrice,
          current_price: orderData.targetPrice, // Will be updated by price monitoring
          status: 'monitoring',
          expires_at: expiresAt.toISOString(),
          condition_value: {
            payment_intent_id: confirmedIntent.id,
            escrow_amount: totalAmount,
            platform_fee: platformFee
          }
        })
        .select()
        .single()

      if (orderError) throw orderError

      // Update payment intent metadata with buy order ID
      await stripe.paymentIntents.update(confirmedIntent.id, {
        metadata: {
          ...confirmedIntent.metadata,
          buy_order_id: buyOrder.id
        }
      })

      // Create escrow record
      await supabase
        .from('escrow_payments')
        .insert({
          buy_order_id: buyOrder.id,
          stripe_payment_intent_id: confirmedIntent.id,
          stripe_payment_method_id: orderData.paymentMethodId,
          escrow_amount: totalAmount / 100, // Convert back to currency units
          platform_fee: platformFee / 100,
          merchant_amount: merchantAmount / 100,
          status: 'held'
        })

      return {
        buyOrder,
        paymentIntent: confirmedIntent,
        error: null
      }
    } catch (error) {
      console.error('Payment creation error:', error)
      return { buyOrder: null, paymentIntent: null, error }
    }
  }

  // Execute payment when buy order conditions are met
  static async executeBuyOrderPayment(buyOrderId: string) {
    try {
      // Get buy order with payment details
      const { data: buyOrder } = await supabase
        .from('buy_orders')
        .select(`
          *,
          escrow_payments (*)
        `)
        .eq('id', buyOrderId)
        .single()

      if (!buyOrder || buyOrder.status !== 'monitoring') {
        throw new Error('Invalid buy order for payment execution')
      }

      const escrowPayment = buyOrder.escrow_payments[0]
      if (!escrowPayment || escrowPayment.status !== 'held') {
        throw new Error('No valid escrow payment found')
      }

      // Capture the payment intent (release funds)
      const capturedIntent = await stripe.paymentIntents.capture(
        escrowPayment.stripe_payment_intent_id
      )

      if (capturedIntent.status === 'succeeded') {
        // Update buy order status
        await supabase
          .from('buy_orders')
          .update({
            status: 'fulfilled',
            fulfilled_at: new Date().toISOString()
          })
          .eq('id', buyOrderId)

        // Update escrow payment status
        await supabase
          .from('escrow_payments')
          .update({
            status: 'released',
            released_at: new Date().toISOString()
          })
          .eq('buy_order_id', buyOrderId)

        // Create notifications
        await this.createPaymentNotifications(buyOrder, 'executed')

        return { success: true, paymentIntent: capturedIntent }
      }

      throw new Error('Payment capture failed')
    } catch (error) {
      console.error('Payment execution error:', error)
      return { success: false, error }
    }
  }

  // Refund payment for expired/cancelled orders
  static async refundBuyOrderPayment(buyOrderId: string, reason: 'expired' | 'cancelled') {
    try {
      const { data: buyOrder } = await supabase
        .from('buy_orders')
        .select(`
          *,
          escrow_payments (*)
        `)
        .eq('id', buyOrderId)
        .single()

      if (!buyOrder) throw new Error('Buy order not found')

      const escrowPayment = buyOrder.escrow_payments[0]
      if (!escrowPayment || escrowPayment.status !== 'held') {
        throw new Error('No valid escrow payment to refund')
      }

      // Cancel the payment intent (refund authorization)
      const cancelledIntent = await stripe.paymentIntents.cancel(
        escrowPayment.stripe_payment_intent_id
      )

      if (cancelledIntent.status === 'canceled') {
        // Update buy order status
        await supabase
          .from('buy_orders')
          .update({ status: reason })
          .eq('id', buyOrderId)

        // Update escrow payment status
        await supabase
          .from('escrow_payments')
          .update({
            status: 'refunded',
            refunded_at: new Date().toISOString()
          })
          .eq('buy_order_id', buyOrderId)

        // Create notifications
        await this.createPaymentNotifications(buyOrder, 'refunded')

        return { success: true, refund: cancelledIntent }
      }

      throw new Error('Payment cancellation failed')
    } catch (error) {
      console.error('Payment refund error:', error)
      return { success: false, error }
    }
  }

  // Setup Stripe Connect for merchants
  static async createMerchantConnectAccount(merchantId: string, email: string) {
    try {
      const account = await stripe.accounts.create({
        type: 'express',
        email: email,
        capabilities: {
          card_payments: { requested: true },
          transfers: { requested: true },
        },
        metadata: {
          merchant_id: merchantId
        }
      })

      // Save account ID to merchant record
      await supabase
        .from('merchants')
        .update({ stripe_account_id: account.id })
        .eq('id', merchantId)

      // Create onboarding link
      const accountLink = await stripe.accountLinks.create({
        account: account.id,
        refresh_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/payments/refresh`,
        return_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/payments/success`,
        type: 'account_onboarding',
      })

      return { account, onboardingUrl: accountLink.url, error: null }
    } catch (error) {
      return { account: null, onboardingUrl: null, error }
    }
  }

  // Create payment notifications
  private static async createPaymentNotifications(buyOrder: any, type: 'executed' | 'refunded') {
    const notifications = []

    if (type === 'executed') {
      // Customer notification
      notifications.push({
        user_id: buyOrder.customer_id,
        user_type: 'customer',
        buy_order_id: buyOrder.id,
        title: 'Order Fulfilled! 🎉',
        message: `Your buy order has been completed. Payment of £${buyOrder.target_price} has been processed.`,
        type: 'order_fulfilled'
      })

      // Merchant notification
      notifications.push({
        user_id: buyOrder.merchant_id,
        user_type: 'merchant',
        buy_order_id: buyOrder.id,
        title: 'Payment Received 💰',
        message: `Buy order payment of £${buyOrder.target_price} has been processed and will be transferred to your account.`,
        type: 'order_fulfilled'
      })
    } else if (type === 'refunded') {
      // Customer notification
      notifications.push({
        user_id: buyOrder.customer_id,
        user_type: 'customer',
        buy_order_id: buyOrder.id,
        title: 'Order Refunded',
        message: `Your buy order has been cancelled and the authorized payment has been released.`,
        type: 'order_cancelled'
      })
    }

    if (notifications.length > 0) {
      await supabase.from('notifications').insert(notifications)
    }
  }

  // Get payment analytics for merchants
  static async getMerchantPaymentAnalytics(merchantId: string) {
    try {
      const { data: payments } = await supabase
        .from('escrow_payments')
        .select(`
          *,
          buy_orders!inner(merchant_id, status, created_at)
        `)
        .eq('buy_orders.merchant_id', merchantId)

      const analytics = {
        totalEscrowAmount: 0,
        totalReleased: 0,
        totalRefunded: 0,
        averageOrderValue: 0,
        paymentsByStatus: {
          held: 0,
          released: 0,
          refunded: 0
        }
      }

      payments?.forEach(payment => {
        analytics.totalEscrowAmount += payment.escrow_amount
        analytics.paymentsByStatus[payment.status]++

        if (payment.status === 'released') {
          analytics.totalReleased += payment.merchant_amount
        } else if (payment.status === 'refunded') {
          analytics.totalRefunded += payment.escrow_amount
        }
      })

      analytics.averageOrderValue = payments?.length 
        ? analytics.totalEscrowAmount / payments.length 
        : 0

      return { analytics, error: null }
    } catch (error) {
      return { analytics: null, error }
    }
  }
}

// Database schema additions needed:
/*
-- Add escrow payments table
CREATE TABLE escrow_payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    buy_order_id UUID NOT NULL REFERENCES buy_orders(id) ON DELETE CASCADE,
    stripe_payment_intent_id TEXT NOT NULL UNIQUE,
    stripe_payment_method_id TEXT NOT NULL,
    escrow_amount DECIMAL(10,2) NOT NULL,
    platform_fee DECIMAL(10,2) NOT NULL,
    merchant_amount DECIMAL(10,2) NOT NULL,
    status TEXT NOT NULL DEFAULT 'held' CHECK (status IN ('held', 'released', 'refunded')),
    held_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    released_at TIMESTAMPTZ,
    refunded_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Add Stripe account ID to merchants
ALTER TABLE merchants ADD COLUMN stripe_account_id TEXT UNIQUE;
ALTER TABLE merchants ADD COLUMN stripe_onboarding_complete BOOLEAN DEFAULT FALSE;

-- Add payment-related fields to buy_orders if not already present
ALTER TABLE buy_orders ADD COLUMN payment_status TEXT DEFAULT 'pending' CHECK (payment_status IN ('pending', 'authorized', 'captured', 'refunded'));

-- Indexes
CREATE INDEX idx_escrow_payments_buy_order_id ON escrow_payments(buy_order_id);
CREATE INDEX idx_escrow_payments_status ON escrow_payments(status);
CREATE INDEX idx_escrow_payments_stripe_intent ON escrow_payments(stripe_payment_intent_id);
*/


================================================
File: lib/supabase.ts
================================================
import { createClient } from '@supabase/supabase-js'
import { Database } from '@/types/database'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

if (!supabaseUrl) {
  throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL environment variable')
}

if (!supabaseAnonKey) {
  throw new Error('Missing NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable')
}

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false // Since we're not using auth yet
  }
})



================================================
File: lib/integrations/index.ts
================================================
// src/lib/integrations/index.ts - Platform Integration System
import { supabase } from '../supabase'

export interface IntegrationConfig {
  id: string
  merchant_id: string
  platform: 'shopify' | 'woocommerce' | 'magento' | 'bigcommerce' | 'squarespace'
  credentials: Record<string, string>
  webhook_endpoints: string[]
  sync_settings: {
    products: boolean
    inventory: boolean
    orders: boolean
    customers: boolean
  }
  last_sync: string
  status: 'active' | 'inactive' | 'error'
}

// Base Integration Interface
export abstract class BaseIntegration {
  protected config: IntegrationConfig
  protected merchantId: string

  constructor(config: IntegrationConfig) {
    this.config = config
    this.merchantId = config.merchant_id
  }

  abstract syncProducts(): Promise<{ success: boolean; synced: number; errors: string[] }>
  abstract syncInventory(): Promise<{ success: boolean; updated: number; errors: string[] }>
  abstract createWebhook(event: string, endpoint: string): Promise<boolean>
  abstract handleWebhook(payload: unknown): Promise<void>
  abstract updateProductPrice(productId: string, price: number): Promise<boolean>
}

// Shopify Integration
export class ShopifyIntegration extends BaseIntegration {
  private apiUrl: string
  private headers: Record<string, string>

  constructor(config: IntegrationConfig) {
    super(config)
    this.apiUrl = `https://${config.credentials.shop_domain}/admin/api/2024-01`
    this.headers = {
      'Content-Type': 'application/json',
      'X-Shopify-Access-Token': config.credentials.access_token
    }
  }

  async syncProducts() {
    try {
      const response = await fetch(`${this.apiUrl}/products.json`, {
        headers: this.headers
      })
      
      const data = await response.json()
      const products = data.products || []
      
      let synced = 0
      const errors: string[] = []

      for (const shopifyProduct of products) {
        try {
          // Convert Shopify product to Limina format
          const liminaProduct = {
            merchant_id: this.merchantId,
            shopify_product_id: shopifyProduct.id.toString(),
            title: shopifyProduct.title,
            description: shopifyProduct.body_html,
            price: parseFloat(shopifyProduct.variants[0]?.price || '0'),
            current_price: parseFloat(shopifyProduct.variants[0]?.price || '0'),
            currency: 'GBP', // Should get from shop settings
            image_url: shopifyProduct.images[0]?.src
          }

          // Upsert product in Limina
          const { error } = await supabase
            .from('products')
            .upsert(liminaProduct, { 
              onConflict: 'shopify_product_id',
              ignoreDuplicates: false 
            })

          if (error) {
            errors.push(`Failed to sync ${shopifyProduct.title}: ${error.message}`)
          } else {
            synced++
          }
        } catch (err) {
          errors.push(`Error processing ${shopifyProduct.title}`)
        }
      }

      // Update last sync time
      await this.updateLastSync()

      return { success: errors.length === 0, synced, errors }
    } catch (error) {
      return { success: false, synced: 0, errors: ['Sync failed'] }
    }
  }

  async syncInventory() {
    try {
      // Get all merchant products with Shopify IDs
      const { data: products } = await supabase
        .from('products')
        .select('id, shopify_product_id')
        .eq('merchant_id', this.merchantId)
        .not('shopify_product_id', 'is', null)

      let updated = 0
      const errors: string[] = []

      for (const product of products || []) {
        try {
          // Get inventory from Shopify
          const response = await fetch(
            `${this.apiUrl}/products/${product.shopify_product_id}.json`,
            { headers: this.headers }
          )
          
          const data = await response.json()
          const variant = data.product.variants[0]
          
          if (variant) {
            const newPrice = parseFloat(variant.price)
            
            // Update price in Limina and create price history
            await this.updateProductPriceInternal(product.id, newPrice)
            updated++
          }
        } catch {
          errors.push(`Failed to update inventory for product ${product.id}`)
        }
      }

      return { success: errors.length === 0, updated, errors }
    } catch {
      return { success: false, updated: 0, errors: ['Inventory sync failed'] }
    }
  }

  async createWebhook(event: string, endpoint: string) {
    try {
      const webhookData = {
        webhook: {
          topic: event,
          address: endpoint,
          format: 'json'
        }
      }

      const response = await fetch(`${this.apiUrl}/webhooks.json`, {
        method: 'POST',
        headers: this.headers,
        body: JSON.stringify(webhookData)
      })

      return response.ok
    } catch {
      console.error('Webhook creation failed')
      return false
    }
  }

  async handleWebhook(payload: unknown) {
    if (!payload || typeof payload !== 'object' || !('topic' in payload)) {
      console.log('Invalid webhook payload:', payload)
      return
    }
    const { topic, ...data } = payload as { topic: string; [key: string]: unknown }
    switch (topic) {
      case 'products/update':
        await this.handleProductUpdate(data)
        break
      case 'orders/paid':
        await this.handleOrderPaid(data)
        break
      default:
        console.log(`Unhandled webhook topic: ${topic}`)
    }
  }

  async updateProductPrice(shopifyProductId: string, price: number): Promise<boolean> {
    try {
      // First get the product and variant
      const productResponse = await fetch(
        `${this.apiUrl}/products/${shopifyProductId}.json`,
        { headers: this.headers }
      )
      
      const productData = await productResponse.json()
      const variantId = productData.product.variants[0]?.id

      if (!variantId) return false

      // Update variant price
      const updateData = {
        variant: {
          id: variantId,
          price: price.toString()
        }
      }

      const response = await fetch(
        `${this.apiUrl}/variants/${variantId}.json`,
        {
          method: 'PUT',
          headers: this.headers,
          body: JSON.stringify(updateData)
        }
      )

      return response.ok
    } catch (error) {
      console.error('Price update failed:', error)
      return false
    }
  }

  private async handleProductUpdate(productData: Record<string, unknown>) {
    try {
      const variants = productData.variants as Array<{ price?: string }> | undefined
      const newPrice = parseFloat(variants?.[0]?.price || '0')
      // Find corresponding Limina product
      const { data: product } = await supabase
        .from('products')
        .select('id')
        .eq('shopify_product_id', String(productData.id))
        .eq('merchant_id', this.merchantId)
        .single()
      if (product) {
        await this.updateProductPriceInternal(product.id, newPrice)
      }
    } catch (error) {
      console.error('Product update webhook failed:', error)
    }
  }

  private async handleOrderPaid(orderData: Record<string, unknown>) {
    // Handle when a Shopify order is paid - could trigger buy order fulfillment
    console.log('Order paid webhook received:', orderData.id)
  }

  private async updateProductPriceInternal(productId: string, newPrice: number) {
    try {
      // Update product current_price
      await supabase
        .from('products')
        .update({ current_price: newPrice })
        .eq('id', productId)

      // Add to price history
      await supabase
        .from('price_history')
        .insert({
          product_id: productId,
          price: newPrice
        })

      // Check for buy orders that can be fulfilled
      await this.checkBuyOrderFulfillment(productId, newPrice)
    } catch (error) {
      console.error('Internal price update failed:', error)
    }
  }

  private async checkBuyOrderFulfillment(productId: string, currentPrice: number) {
    try {
      // Get monitoring buy orders for this product where target price is met
      const { data: orders } = await supabase
        .from('buy_orders')
        .select('*')
        .eq('product_id', productId)
        .eq('status', 'monitoring')
        .lte('target_price', currentPrice)

      // Fulfill orders that meet criteria
      for (const order of orders || []) {
        await this.fulfillBuyOrder(order)
      }
    } catch (error) {
      console.error('Buy order fulfillment check failed:', error)
    }
  }

  private async fulfillBuyOrder(order: { id: string; customer_id: string; target_price: number }) {
    try {
      // Update order status
      await supabase
        .from('buy_orders')
        .update({
          status: 'fulfilled',
          fulfilled_at: new Date().toISOString()
        })
        .eq('id', order.id)

      // Trigger payment capture (if payment integration is enabled)
      // await PaymentService.executeBuyOrderPayment(order.id)

      // Create notification
      await supabase
        .from('notifications')
        .insert({
          user_id: order.customer_id,
          user_type: 'customer',
          buy_order_id: order.id,
          title: 'Order Fulfilled! 🎉',
          message: `Your buy order has been fulfilled at £${order.target_price}`,
          type: 'order_fulfilled'
        })
    } catch (error) {
      console.error('Buy order fulfillment failed:', error)
    }
  }

  private async updateLastSync() {
    await supabase
      .from('integrations')
      .update({ last_sync: new Date().toISOString() })
      .eq('merchant_id', this.merchantId)
      .eq('platform', 'shopify')
  }
}

// WooCommerce Integration
export class WooCommerceIntegration extends BaseIntegration {
  private apiUrl: string
  private auth: string

  constructor(config: IntegrationConfig) {
    super(config)
    this.apiUrl = `${config.credentials.site_url}/wp-json/wc/v3`
    this.auth = Buffer.from(
      `${config.credentials.consumer_key}:${config.credentials.consumer_secret}`
    ).toString('base64')
  }

  async syncProducts() {
    try {
      const response = await fetch(`${this.apiUrl}/products`, {
        headers: {
          'Authorization': `Basic ${this.auth}`,
          'Content-Type': 'application/json'
        }
      })

      const products = await response.json()
      let synced = 0
      const errors: string[] = []

      for (const wcProduct of products) {
        try {
          const liminaProduct = {
            merchant_id: this.merchantId,
            shopify_product_id: `wc_${wcProduct.id}`,
            title: wcProduct.name,
            description: wcProduct.description,
            price: parseFloat(wcProduct.regular_price || wcProduct.price || '0'),
            current_price: parseFloat(wcProduct.price || '0'),
            currency: 'GBP',
            image_url: wcProduct.images[0]?.src
          }

          const { error } = await supabase
            .from('products')
            .upsert(liminaProduct, { 
              onConflict: 'shopify_product_id',
              ignoreDuplicates: false 
            })

          if (!error) synced++
          else errors.push(`Failed to sync ${wcProduct.name}`)
        } catch (err) {
          errors.push(`Error processing ${wcProduct.name}`)
        }
      }

      await this.updateLastSync()
      return { success: errors.length === 0, synced, errors }
    } catch (error) {
      return { success: false, synced: 0, errors: ['Sync failed'] }
    }
  }

  async syncInventory() {
    // Similar implementation to Shopify but using WooCommerce API
    return { success: true, updated: 0, errors: [] }
  }

  async createWebhook(event: string, endpoint: string) {
    try {
      const webhookData = {
        name: `Limina ${event}`,
        topic: event,
        delivery_url: endpoint,
        status: 'active'
      }

      const response = await fetch(`${this.apiUrl}/webhooks`, {
        method: 'POST',
        headers: {
          'Authorization': `Basic ${this.auth}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(webhookData)
      })

      return response.ok
    } catch {
      return false
    }
  }

  async handleWebhook(payload: unknown) {
    // Handle WooCommerce webhook events
    console.log('WooCommerce webhook received:', payload)
  }

  async updateProductPrice(wcProductId: string, price: number) {
    try {
      const updateData = {
        regular_price: price.toString(),
        price: price.toString()
      }

      const response = await fetch(`${this.apiUrl}/products/${wcProductId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Basic ${this.auth}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      })

      return response.ok
    } catch {
      return false
    }
  }

  private async updateLastSync() {
    await supabase
      .from('integrations')
      .update({ last_sync: new Date().toISOString() })
      .eq('merchant_id', this.merchantId)
      .eq('platform', 'woocommerce')
  }
}

// Integration Factory
export class IntegrationFactory {
  static create(config: IntegrationConfig): BaseIntegration {
    switch (config.platform) {
      case 'shopify':
        return new ShopifyIntegration(config)
      case 'woocommerce':
        return new WooCommerceIntegration(config)
      default:
        throw new Error(`Unsupported platform: ${config.platform}`)
    }
  }
}

// Integration Manager
export class IntegrationManager {
  static async setupIntegration(merchantId: string, platform: string, credentials: Record<string, string>) {
    try {
      // Save integration config
      const config: Omit<IntegrationConfig, 'id'> = {
        merchant_id: merchantId,
        platform: platform as 'shopify' | 'woocommerce' | 'magento' | 'bigcommerce' | 'squarespace',
        credentials,
        webhook_endpoints: [],
        sync_settings: {
          products: true,
          inventory: true,
          orders: true,
          customers: false
        },
        last_sync: new Date().toISOString(),
        status: 'active'
      }

      const { data, error } = await supabase
        .from('integrations')
        .insert(config)
        .select()
        .single()

      if (error) throw error

      // Create integration instance and set up webhooks
      const integration = IntegrationFactory.create(data as IntegrationConfig)
      
      // Set up webhooks
      const webhookEndpoint = `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/${platform}`
      await integration.createWebhook('products/update', webhookEndpoint)
      await integration.createWebhook('orders/paid', webhookEndpoint)

      // Perform initial sync
      const syncResult = await integration.syncProducts()
      
      return { 
        success: true, 
        integration: data,
        syncResult 
      }
    } catch {
      const errMsg = 'Setup integration failed'
      return { success: false, error: errMsg }
    }
  }

  static async syncMerchantData(merchantId: string) {
    try {
      // Get all active integrations for merchant
      const { data: integrations } = await supabase
        .from('integrations')
        .select('*')
        .eq('merchant_id', merchantId)
        .eq('status', 'active')

      const results = []

      for (const config of integrations || []) {
        const integration = IntegrationFactory.create(config as IntegrationConfig)
        
        if (config.sync_settings.products) {
          const productSync = await integration.syncProducts()
          results.push({ type: 'products', ...productSync })
        }

        if (config.sync_settings.inventory) {
          const inventorySync = await integration.syncInventory()
          results.push({ type: 'inventory', ...inventorySync })
        }
      }

      return { success: true, results }
    } catch {
      const errMsg = 'Sync merchant data failed'
      return { success: false, error: errMsg }
    }
  }

  static async handleWebhook(platform: string, payload: unknown) {
    try {
      // Find integration by platform (you might want to include merchant info in webhook)
      const { data: integrations } = await supabase
        .from('integrations')
        .select('*')
        .eq('platform', platform)
        .eq('status', 'active')

      for (const config of integrations || []) {
        const integration = IntegrationFactory.create(config as IntegrationConfig)
        await integration.handleWebhook(payload)
      }

      return { success: true }
    } catch {
      const errMsg = 'Handle webhook failed'
      return { success: false, error: errMsg }
    }
  }
}

// Database schema for integrations
/*
-- Create integrations table
CREATE TABLE integrations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
    platform TEXT NOT NULL CHECK (platform IN ('shopify', 'woocommerce', 'magento', 'bigcommerce', 'squarespace')),
    credentials JSONB NOT NULL,
    webhook_endpoints TEXT[],
    sync_settings JSONB NOT NULL DEFAULT '{"products": true, "inventory": true, "orders": true, "customers": false}',
    last_sync TIMESTAMPTZ,
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'error')),
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create sync logs table for debugging
CREATE TABLE sync_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    integration_id UUID NOT NULL REFERENCES integrations(id) ON DELETE CASCADE,
    sync_type TEXT NOT NULL,
    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    status TEXT NOT NULL CHECK (status IN ('running', 'completed', 'failed')),
    items_processed INTEGER DEFAULT 0,
    errors JSONB DEFAULT '[]',
    metadata JSONB DEFAULT '{}'
);

-- Indexes
CREATE INDEX idx_integrations_merchant_id ON integrations(merchant_id);
CREATE INDEX idx_integrations_platform ON integrations(platform);
CREATE INDEX idx_sync_logs_integration_id ON sync_logs(integration_id);
CREATE INDEX idx_sync_logs_started_at ON sync_logs(started_at);
*/


================================================
File: types/database.ts
================================================
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export interface Database {
  public: {
    Tables: {
      merchants: {
        Row: {
          id: string
          name: string
          email: string
          shopify_domain: string | null
          shopify_access_token: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          name: string
          email: string
          shopify_domain?: string | null
          shopify_access_token?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          name?: string
          email?: string
          shopify_domain?: string | null
          shopify_access_token?: string | null
          created_at?: string
          updated_at?: string
        }
      }
      customers: {
        Row: {
          id: string
          email: string
          name: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          email: string
          name?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          email?: string
          name?: string | null
          created_at?: string
          updated_at?: string
        }
      }
      products: {
        Row: {
          id: string
          merchant_id: string
          shopify_product_id: string | null
          title: string
          description: string | null
          price: number
          current_price: number
          currency: string
          image_url: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          merchant_id: string
          shopify_product_id?: string | null
          title: string
          description?: string | null
          price: number
          current_price: number
          currency?: string
          image_url?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          merchant_id?: string
          shopify_product_id?: string | null
          title?: string
          description?: string | null
          price?: number
          current_price?: number
          currency?: string
          image_url?: string | null
          created_at?: string
          updated_at?: string
        }
      }
      buy_orders: {
        Row: {
          id: string
          merchant_id: string
          product_id: string
          customer_id: string
          customer_email: string
          customer_name: string | null
          target_price: number
          current_price: number
          currency: string
          status: 'pending' | 'monitoring' | 'fulfilled' | 'cancelled' | 'expired'
          condition_type: 'price' | 'inventory' | 'date'
          condition_value: Json
          expires_at: string
          fulfilled_at: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          merchant_id: string
          product_id: string
          customer_id: string
          customer_email: string
          customer_name?: string | null
          target_price: number
          current_price: number
          currency?: string
          status?: 'pending' | 'monitoring' | 'fulfilled' | 'cancelled' | 'expired'
          condition_type?: 'price' | 'inventory' | 'date'
          condition_value?: Json
          expires_at: string
          fulfilled_at?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          merchant_id?: string
          product_id?: string
          customer_id?: string
          customer_email?: string
          customer_name?: string | null
          target_price?: number
          current_price?: number
          currency?: string
          status?: 'pending' | 'monitoring' | 'fulfilled' | 'cancelled' | 'expired'
          condition_type?: 'price' | 'inventory' | 'date'
          condition_value?: Json
          expires_at?: string
          fulfilled_at?: string | null
          created_at?: string
          updated_at?: string
        }
      }
      price_history: {
        Row: {
          id: string
          product_id: string
          price: number
          currency: string
          recorded_at: string
        }
        Insert: {
          id?: string
          product_id: string
          price: number
          currency?: string
          recorded_at?: string
        }
        Update: {
          id?: string
          product_id?: string
          price?: number
          currency?: string
          recorded_at?: string
        }
      }
      notifications: {
        Row: {
          id: string
          user_id: string
          user_type: 'merchant' | 'customer'
          buy_order_id: string | null
          title: string
          message: string
          type: 'price_alert' | 'order_fulfilled' | 'order_expired' | 'new_order'
          read_at: string | null
          created_at: string
        }
        Insert: {
          id?: string
          user_id: string
          user_type: 'merchant' | 'customer'
          buy_order_id?: string | null
          title: string
          message: string
          type: 'price_alert' | 'order_fulfilled' | 'order_expired' | 'new_order'
          read_at?: string | null
          created_at?: string
        }
        Update: {
          id?: string
          user_id?: string
          user_type?: 'merchant' | 'customer'
          buy_order_id?: string | null
          title?: string
          message?: string
          type?: 'price_alert' | 'order_fulfilled' | 'order_expired' | 'new_order'
          read_at?: string | null
          created_at?: string
        }
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}


